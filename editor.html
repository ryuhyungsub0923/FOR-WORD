<!-- =========================================================
FILE: editor.html
ì—…ë°ì´íŠ¸ ìš”ì•½:
- ëª©ì°¨(PSST í•˜ìœ„ í•­ëª©) ë“œë˜ê·¸ì•¤ë“œë¡­ ì¬ì •ë ¬ + ë¡œì»¬ ì €ì¥(persist)
- ì—ë””í„° í…ìŠ¤íŠ¸ ë“œë˜ê·¸/ì„ íƒ í•˜ì´ë¼ì´íŠ¸ ë³µì›(ë³¼ë“œ/ì´íƒ¤ë¦­ ë“± ì •ìƒ ë™ì‘)
- ì •ë ¬ ë²„íŠ¼ ì•„ì´ì½˜ì„ ì›Œë“œ/í•œê¸€ ìŠ¤íƒ€ì¼ SVG(ì¢Œ/ì¤‘ì•™/ìš°)ë¡œ êµì²´
- í‘œ ë²„íŠ¼: ê¸°ë³¸ 2Ã—2 ì‚½ì…, í‘œ ìœ„/ì˜†ì— +ë²„íŠ¼(í–‰/ì—´ ì¶”ê°€) ë…¸ì…˜ì‹ UX
- ë‚˜ë¨¸ì§€ ê¸°ì¡´ ê¸°ëŠ¥(ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ/í˜ì´ì§€ë·°/ë©”ëª¨/ì¶”ì²œ ë“±) ìœ ì§€
- ìš°ì¸¡ ì±—ë´‡ íƒ­: ë¡œì»¬ API(http://localhost:3000/api/chat) ì—°ë™ + ëŒ€í™” ë¡œì»¬ ì €ì¥
========================================================= -->
<!doctype html>
<html lang="ko" class="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FOR:WORD â€” Editor View</title>

  <!-- ê°œë°œìš©: Tailwind CDN (í”„ë¡œë•ì…˜ì€ CLI/PostCSS ê¶Œì¥) -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard@1.3.9/dist/web/static/pretendard.css"/>
  <script>
    window.tailwind = window.tailwind || {};
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { fontFamily: { sans: ['Pretendard','system-ui','sans-serif'] } } }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>

  <style>
    :root{
      --sb-nav-top: rgba(30,31,31,0.9);
      --sb-nav-bottom: #848C95;
      --sb-main-top: #2C2C2C;
      --sb-main-bottom: #929292;

      --sidebar-w: 212px;
      --sidebar-w-collapsed: 68px;
      --mobile-nav-h: 64px;

      --canvas-bg: #FFFFFF;
      --work-bg: #F7F7F8;
      --ink-1: #111827;
      --ink-2: #6B7280;
      --divider: #E5E7EB;

      --index-w: 260px;
      --right-w: 360px;
      --editor-min-h: 520px;
      --docbar-h: 56px;

      /* ===== A4 base(mm) + scale ===== */
      --page-scale: 1;
      --page-w-base: 210mm;
      --page-h-base: 297mm;
      --page-pad-base: 16mm;
      --page-gap-base: 10mm;

      /* derived (í™•ëŒ€ ì ìš©) */
      --page-w:  calc(var(--page-w-base)  * var(--page-scale));
      --page-h:  calc(var(--page-h-base)  * var(--page-scale));
      --page-pad:calc(var(--page-pad-base)* var(--page-scale));
      --page-gap:calc(var(--page-gap-base)* var(--page-scale));

      --page-shadow: 0 8px 28px rgba(0,0,0,.10);
      --page-border: 0.5px solid #E5E7EB; /* ì´ˆìŠ¬ë¦¼ í…Œë‘ë¦¬ */
    }

    body{ overflow:hidden; color:var(--ink-1); }
    #noteCol, .center-wrap, .right-col{ content-visibility:auto; contain-intrinsic-size:800px 1000px; }

    /* ===== Sidebar (ìƒëµ) ===== */
    .sidebar{ width:var(--sidebar-w); background:linear-gradient(to bottom, var(--sb-nav-top), var(--sb-nav-bottom)); transition:width .18s ease; }
    .sidebar[data-collapsed="true"]{ width:var(--sidebar-w-collapsed); }
    .brand-text{ font-size:18px; font-weight:600; color:#fff; letter-spacing:-0.02em; white-space:nowrap; }
    .sidebar[data-collapsed="true"] .brand-text{ display:none; }
    .brand-wrapper{ display:flex; align-items:center; justify-content:space-between; }
    .brand-left{ display:flex; align-items:center; gap:12px; cursor:pointer; }
    .sidebar[data-collapsed="true"] .brand-left{ justify-content:center; width:100%; gap:0!important; }
    .logo-wrapper{ width:32px; height:32px; border-radius:6px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .logo-wrapper img{ width:100%; height:100%; object-fit:contain; }
    .sidebar[data-collapsed="true"] .logo-wrapper{ display:none; }
    .expand-icon-wrapper{ width:32px; height:32px; border-radius:6px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); display:none; align-items:center; justify-content:center; }
    .sidebar[data-collapsed="true"] .expand-icon-wrapper{ display:flex; }
    .collapse-btn{ width:28px; height:28px; border-radius:6px; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); cursor:pointer; }
    .collapse-icon{ transition:transform .18s ease; }
    .sidebar[data-collapsed="true"] .collapse-icon{ transform:rotate(180deg); }
    .sidebar-nav-container{ display:flex; flex-direction:column; flex-grow:1; padding:24px 16px; }
    .sidebar[data-collapsed="true"] .sidebar-nav-container{ padding-left:10px; padding-right:10px; }
    .sidebar-nav-btn{ width:180px; height:48px; display:flex; align-items:center; gap:10px; border-radius:8px; padding:0 12px; color:inherit; text-decoration:none; transition:background .12s ease; }
    .sidebar-nav-btn:hover{ background:rgba(255,255,255,0.1); }
    .sidebar[data-collapsed="true"] .sidebar-nav-btn{ width:48px; justify-content:center; gap:0; padding:0; }
    .sidebar[data-collapsed="true"] .sidebar-nav-btn span.nav-label{ display:none; }
    .sidebar-divider{ border-top:1px solid rgba(255,255,255,0.15); margin:16px 0; }
    .main-bg{ background:linear-gradient(to bottom, var(--sb-main-top), var(--sb-main-bottom)); }
    .mobile-nav-bg{ background:linear-gradient(to bottom, var(--sb-nav-top), var(--sb-nav-bottom)); }

    /* ===== ì¢Œì¸¡ ëª©ì°¨ ===== */
    #noteCol{ width:var(--index-w); background:#fff; color:#0F172A; display:flex; flex-direction:column; border-right:1px solid var(--divider); height:100vh; }
    .note-head{ height:44px; display:flex; align-items:center; gap:6px; padding:0 10px; border-bottom:1px solid var(--divider); font-size:12px; color:#6B7280; }
    .note-scroll{ flex:1; overflow:auto; padding:10px; }
    .note-footer{ border-top:1px solid var(--divider); padding:10px; background:#fff; }
    .toc-tree{ font-size:13px; }
    .toc-ul{ list-style:none; margin:0; padding:0; }
    .toc-li{ margin:2px 0; }
    .node{ width:100%; display:flex; align-items:center; gap:6px; border:1px solid #E5E7EB; background:#fff; color:#0F172A; border-radius:8px; padding:6px 8px; cursor:pointer; user-select:none; }
    .node:hover{ background:#F8FAFC; }
    .node .caret{ width:16px; height:16px; display:flex; align-items:center; justify-content:center; color:#64748B; flex:0 0 16px; }
    .node .badge{ font-size:11px; padding:2px 6px; border-radius:6px; background:#EEF2FF; color:#1f2345; border:1px solid #E6E7FF; flex:0 0 auto; }
    .node .title{ flex:1 1 auto; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .toc-children{ margin:6px 0 6px 18px; }
    .is-active{ outline:2px solid #3655ff55; }
    .is-collapsed > .toc-children{ display:none; }

    /* DnD í‘œì‹œ */
    .node[draggable="true"]{ cursor:grab; }
    .node.dragging{ opacity:.5; }
    .drop-marker-before{ box-shadow: inset 0 2px 0 #3655ff; }
    .drop-marker-after{  box-shadow: inset 0 -2px 0 #3655ff; }

    /* ===== ì¤‘ì•™ ===== */
    .center-wrap{ flex:1 1 auto; min-width:0; background:var(--canvas-bg); display:flex; flex-direction:column; height:100vh; }
    .doc-topbar{ height:var(--docbar-h); display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--divider); padding:0 14px; background:var(--canvas-bg); position:sticky; top:0; z-index:5; }
    .doc-title{ font-size:14px; color:#999; outline:none; border:none; background:transparent; flex:1 1 auto; min-width:0; margin-right:8px; height:calc(var(--docbar-h) - 2px); line-height:calc(var(--docbar-h) - 2px); padding:0; }
    .doc-actions{ display:flex; align-items:center; gap:14px; font-size:12px; color:#374151; }
    .chip{ font-size:12px; padding:4px 8px; border-radius:999px; background:#111827; color:#fff; font-weight:700; }
    .toolbar-wrap{ border-bottom:1px solid var(--divider); background:#F9FAFB; }
    .tag-row{ height:40px; display:flex; align-items:center; gap:8px; padding:0 12px; }
    .tag-pill{ font-size:12px; border:1px solid #E5E7EB; background:#fff; padding:6px 10px; border-radius:999px; cursor:pointer; color:#374151; }
    .tag-pill.active{ background:#111827; color:#fff; border-color:#111827; }
    .tag-add{ font-size:12px; border:1px solid #E5E7EB; background:#fff; padding:6px 10px; border-radius:999px; cursor:pointer; color:#374151; }
    .toolbar-row{ display:flex; align-items:center; gap:10px; padding:10px 12px; flex-wrap:wrap; }
    .tbtn{ height:28px; min-width:28px; padding:0 8px; border-radius:6px; border:1px solid #D1D5DB; background:#fff; display:flex; align-items:center; justify-content:center; gap:6px; font-size:13px; cursor:pointer; color:#111827; }
    .tsep{ height:28px; width:1px; background:#E5E7EB; margin:0 2px; }

    /* ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ: ê°€ë¡œ 100% + ë‚´ë¶€ A4 ì¤‘ì•™ ì •ë ¬ */
    .editor-area{
      flex:1 1 auto; min-height:0; overflow:auto; background:#f7f7f8;
      padding-left:  max(12px, calc((100% - var(--page-w))/2));
      padding-right: max(12px, calc((100% - var(--page-w))/2));
      padding-top:16px;
      padding-bottom: calc(16px + 56px);
    }

    /* í˜ì´ì§€ ë£¨íŠ¸ */
    .page-root{
      min-height:calc(var(--editor-min-h) - 32px);
      display:flex; flex-direction:column; align-items:center; gap:0;
      counter-reset: page;
    }

    .page{
      position:relative;
      counter-increment: page;
      width:var(--page-w);
      height:var(--page-h); /* ê³ ì • ë†’ì´ â†’ ìë™ ë¶„í•  */
      background:#fff; color:#111827;
      border:var(--page-border);
      box-shadow:var(--page-shadow);
      border-radius:0; /* ê°ì§„ ëª¨ì„œë¦¬ */
      padding:var(--page-pad);
      margin:0;
      box-sizing:border-box;
      overflow:hidden;
    }

    /* í˜ì´ì§€ êµ¬ë¶„ì„  */
    .page-divider{
      width:var(--page-w);
      display:flex; flex-direction:column; align-items:center;
      margin: calc(var(--page-gap)/2) 0;
      user-select:none; pointer-events:none;
    }
    .page-divider .line{ width:100%; border-top:1px dashed #cbd5e1; }
    .page-divider .badge{ margin-top:6px; font-size:12px; color:#94a3b8; }

    /* ì½˜í…ì¸  ê·œì¹™ */
    .page *{ break-inside:auto; }
    .page p, .page li, .page blockquote{ line-height:1.8; font-size:14px; margin:0 0 10px 0; }
    .page h1{ font-size:24px; font-weight:800; margin:0 0 16px; }
    .page h2{ font-size:20px; font-weight:700; margin:14px 0; }
    .page h3{ font-size:16px; font-weight:700; margin:12px 0; }
    .page table{ width:100%; border-collapse:collapse; margin:10px 0; table-layout:fixed; }
    .page th,.page td{ border:1px solid #e5e7eb; padding:6px 8px; font-size:13px; vertical-align:top; }
    .page td:empty::after{ content:'\00a0'; } /* ë¹ˆì¹¸ í´ë¦­ ìš©ì´ */
    .page img{
      display:block; margin:8px auto;
      max-width:100%; height:auto;
      max-height: calc(var(--page-h) - 2*var(--page-pad));
      object-fit:contain;
    }

    /* ì—°ì†ë³´ê¸°(í˜ì´ì§€ë·° OFF) */
    .page-root[data-page-view="false"]{ align-items:stretch; }
    .page-root[data-page-view="false"] .page{
      width:auto; height:auto;
      box-shadow:none; border:none; border-radius:0; padding:0; overflow:visible;
    }
    .page-root[data-page-view="false"] .page-divider{ display:none; }

    .editor-placeholder:empty::before{
      content:'í´ë¦­í•˜ì—¬ ì‘ì„±ì„ ì‹œì‘í•˜ì„¸ìš”. ì¢Œì¸¡ ëª©ì°¨ì—ì„œ ë¬¸ì„œë¥¼ ì „í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'; 
      color:#9CA3AF;
    }

    /* ===== ì¤‘ì•™ í…ìŠ¤íŠ¸ ì…ë ¥: í¬ì»¤ìŠ¤/ì„ íƒ ===== */
    .doc-title:focus,
    .page:focus,
    .page *:focus{ outline:none !important; box-shadow:none !important; }
    /* âœ… ë“œë˜ê·¸/ì„ íƒ í•˜ì´ë¼ì´íŠ¸ ë³µì› */
    .page ::selection{ background:rgba(54,85,255,0.22); color:inherit; }
    .page ::-moz-selection{ background:rgba(54,85,255,0.22); color:inherit; }
    .doc-title::selection,
    .chat-input::selection,
    .memo-input::selection{ background:rgba(54,85,255,0.22); color:inherit; }
    .doc-title::-moz-selection,
    .chat-input::-moz-selection,
    .memo-input::-moz-selection{ background:rgba(54,85,255,0.22); color:inherit; }

    input[type="text"]:focus,
    textarea:focus,
    .chat-input:focus,
    .memo-input:focus{ outline:none !important; box-shadow:none !important; border-color:#D1D5DB; }

    /* ===== ìš°ì¸¡ íŒ¨ë„ ===== */
    .right-col{ width:var(--right-w); background:#FAFAFB; display:flex; flex-direction:column; height:100vh; border-left:1px solid var(--divider); color:#111827; }

    /* íƒ­ ë°”: 1/3 ê· ë“±í­ + ì„ íƒ íƒ­ í°ìƒ‰ ë¼ìš´ë“œ ë°•ìŠ¤ */
    .tabs{ height:52px; display:flex; align-items:center; gap:6px; padding:6px; border-bottom:1px solid var(--divider); background:#F3F4F6; }
    .tab{ flex:1 1 0; display:inline-flex; align-items:center; justify-content:center; gap:6px; padding:8px 10px; border-radius:12px; font-weight:700; font-size:13px; color:#374151; cursor:pointer; border:1px solid transparent; white-space:nowrap; }
    .tab svg{ flex:0 0 auto; }
    .tab[aria-selected="true"]{ background:#FFFFFF; border-color:#E5E7EB; box-shadow:0 1px 2px rgba(0,0,0,.04); }

    .panel{ display:none; height:calc(100vh - 52px); }
    .panel[data-active="true"]{ display:flex; flex-direction:column; }

    .chat-log{ flex:1 1 auto; overflow:auto; padding:12px; }
    .bubble{ max-width:85%; border-radius:10px; padding:10px 12px; font-size:13px; line-height:1.55; }
    .bot{ background:#FFFFFF; border:1px solid #E5E7EB; color:#111827; margin-right:auto; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .me{ background:#111827; color:#fff; margin-left:auto; }
    .chat-ctl{ border-top:1px solid var(--divider); background:#fff; padding:6px 10px; display:flex; align-items:center; gap:8px; justify-content:space-between; }
    .small-btn{ height:28px; padding:0 10px; border:1px solid #D1D5DB; border-radius:8px; background:#fff; font-size:12px; color:#111827; display:inline-flex; align-items:center; gap:6px; cursor:pointer; }
    .chat-stats{ font-size:12px; color:#6B7280; }
    .chat-bar{ border-top:1px solid var(--divider); background:#fff; padding:10px; display:flex; gap:8px; }
    .chat-input{ flex:1; border:1px solid #D1D5DB; border-radius:12px; padding:10px 12px; font-size:13px; }
    .send-btn{ width:36px; height:36px; border-radius:10px; background:#111827; color:#fff; display:flex; align-items:center; justify-content:center; }

    /* ë©”ëª¨ UI */
    .memo-tools{ display:flex; gap:8px; padding:10px 10px; border-bottom:1px solid var(--divider); background:#fff; align-items:center; }
    .memo-search{ flex:1; height:32px; border:1px solid #D1D5DB; border-radius:10px; padding:0 10px; font-size:13px; }
    .memo-quick{ background:#fff; border:1px solid #E5E7EB; border-radius:10px; padding:12px; margin:10px; }
    .memo-quick .hint{ font-size:12px; color:#6B7280; margin-bottom:6px; }
    .memo-quick .memo-input{ min-height:64px; }

    .memo-scroll{ flex:1; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:18px; }
    .memo-sect-head{ font-weight:800; font-size:12px; color:#111827; padding:2px 0; }
    .bmc-grid{ display:grid; grid-template-columns:1fr; gap:10px; }
    .bmc-card{ background:#fff; border:1px solid #E5E7EB; border-radius:10px; padding:12px; }
    .bmc-title{ font-weight:800; font-size:12px; color:#111827; margin-bottom:8px; }
    .bmc-ro{ font-size:13px; line-height:1.65; color:#111827; background:#FFFFFF; border:none; outline:none; border-radius:8px; padding:8px 10px; white-space:pre-wrap; word-break:break-word; }
    .bmc-empty{ color:#9CA3AF; }
    .memo-grid{ display:grid; grid-template-columns:1fr; gap:10px; }
    .memo-card{ background:#fff; border:1px solid #E5E7EB; border-radius:10px; padding:12px; position:relative; }
    .memo-input{ width:100%; min-height:66px; font-size:13px; line-height:1.65; color:#111827; background:#FFFFFF; border:none; outline:none; border-radius:8px; padding:8px 10px; resize:none; overflow:hidden; }
    .memo-del{ position:absolute; top:8px; right:8px; height:24px; padding:0 8px; border:1px solid #E5E7EB; border-radius:6px; background:#fff; font-size:12px; color:#6B7280; cursor:pointer; }
    .memo-bar{ border-top:1px solid var(--divider); padding:10px; background:#fff; display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .memo-info{ font-size:12px; color:#6B7280; }
    .memo-add{ height:30px; padding:0 12px; border:1px solid #111827; background:#111827; color:#fff; border-radius:8px; font-size:12px; font-weight:700; cursor:pointer; }

    /* ===== ì¶”ì²œ ìŠ¤íƒ€ì¼ ===== */
    .reco-list{ display:flex; flex-direction:column; gap:10px; }
    .reco-item{ background:#fff; border:1px solid #E5E7EB; border-radius:10px; padding:10px; }
    .reco-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .reco-title{ font-weight:700; font-size:13px; color:#111827; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .reco-score{ font-size:12px; font-weight:800; color:#111827; }
    .reco-sent{ margin-top:6px; font-size:13px; line-height:1.6; color:#374151; }
    .reco-path{ margin-top:4px; font-size:11px; color:#6B7280; }

    /* ===== ì´ë¯¸ì§€ ì„ íƒ/ë¦¬ì‚¬ì´ì € ===== */
    .img-selected{ outline:2px solid #3B82F6; outline-offset:2px; }
    #imgResizer{
      position:fixed; width:12px; height:12px; background:#3B82F6; border:2px solid #fff; border-radius:2px;
      box-shadow:0 1px 3px rgba(0,0,0,.2); cursor:se-resize; z-index:50; display:none;
    }
    #imgToolbar{
      position:fixed; z-index:50; display:none;
      background:#fff; border:1px solid #E5E7EB; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,.08);
      padding:6px; gap:6px;
    }
    #imgToolbar .btn{ border:1px solid #D1D5DB; background:#fff; padding:4px 8px; border-radius:6px; font-size:12px; cursor:pointer; }

    /* ===== í‘œ ì˜¤ë²„ë ˆì´(ë…¸ì…˜ì‹ + ë²„íŠ¼) ===== */
    .tbl-plus-btn{
      position:fixed; z-index:60; width:22px; height:22px; border-radius:6px;
      border:1px solid #D1D5DB; background:#fff; display:none; align-items:center; justify-content:center;
      font-size:16px; line-height:1; box-shadow:0 1px 2px rgba(0,0,0,.06); cursor:pointer; user-select:none;
    }
  </style>
</head>

<body class="font-sans text-white bg-[var(--sb-main-top)] min-h-screen flex flex-col md:flex-row">

  <!-- LEFT SIDEBAR -->
  <aside id="sidebar" class="sidebar hidden md:flex flex-col shrink-0 select-none" data-collapsed="false">
    <div class="brand-area border-b border-white/10 px-[16px] py-[20px]">
      <div class="brand-wrapper">
        <div id="brandToggleArea" class="brand-left">
          <div class="logo-wrapper"><img src="home_assets/logo.png" alt="FOR:WORD" loading="lazy"/></div>
          <div class="expand-icon-wrapper">
            <svg class="w-[16px] h-[16px] text-white/80" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="m9 6 6 6-6 6"/></svg>
          </div>
          <div class="flex flex-col"><div class="brand-text">FOR:WORD</div></div>
        </div>
        <div class="brand-right">
          <div id="collapseToggle" class="collapse-btn" aria-label="Collapse sidebar">
            <svg class="collapse-icon w-[16px] h-[16px] text-white/80" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
          </div>
        </div>
      </div>
    </div>

    <nav class="sidebar-nav-container text-sm">
      <a href="home.html" class="sidebar-nav-btn mb-[4px] hover:bg-white/10">
        <img src="home_assets/Main_icon.svg" alt="Main" class="w/[20px] h/[20px] object-contain" loading="lazy"/>
        <span class="nav-label">Main</span>
      </a>
      <a href="editor.html" class="sidebar-nav-btn mb/[4px] bg-white/10 hover:bg-white/15">
        <img src="home_assets/Editor_icon.svg" alt="Editor View" class="w/[20px] h/[20px] object-contain" loading="lazy"/>
        <span class="nav-label">Editor View</span>
      </a>
      <a href="projects.html" class="sidebar-nav-btn mb/[4px] hover:bg-white/10">
        <img src="home_assets/Project_icon.svg" alt="Projects" class="w/[20px] h/[20px] object-contain opacity-70" loading="lazy"/>
        <span class="nav-label">Projects</span>
      </a>
      <a href="graph.html" class="sidebar-nav-btn mb/[16px] hover:bg-white/10">
        <img src="home_assets/Graph_icon.svg" alt="Knowledge Graph" class="w/[20px] h/[20px] object-contain opacity-70" loading="lazy"/>
        <span class="nav-label">Knowledge Graph</span>
      </a>
      <div class="sidebar-divider"></div>
      <a href="social.html" class="sidebar-nav-btn mb/[4px] hover:bg-white/10">
        <img src="home_assets/Social_icon.svg" alt="Social" class="w/[20px] h/[20px] object-contain" loading="lazy"/>
        <span class="nav-label">Social</span>
      </a>
    </nav>

    <div class="border-t border-white/10 text-xs text-white/60">
      <div class="p-4">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-md bg-white/10 border border-white/20 flex items-center justify-center overflow-hidden">
            <img src="home_assets/Profile_icon.svg" alt="Profile" loading="lazy"/>
          </div>
          <div class="leading-tight">
            <span class="text-white/90 text-[13px] font-medium">hs r</span><br/>
            <span class="text-white/50 text-[11px]">Workspace</span>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- MOBILE NAV -->
  <nav class="md:hidden fixed bottom-0 left-0 right-0 z-50 flex justify-around items-center border-t border-white/10 backdrop-blur-md mobile-nav-bg" style="height:var(--mobile-nav-h);">
    <a href="home.html" class="flex flex-col items-center gap-1 text-[11px] text-white/70">
      <img src="home_assets/Main_icon.svg" alt="Main" class="w/[24px] h/[24px] object-contain" loading="lazy"/><span>Main</span>
    </a>
    <a href="editor.html" class="flex flex-col items-center gap-1 text-[11px] text-white/70">
      <img src="home_assets/Editor_icon.svg" alt="Editor" class="w/[24px] h/[24px] object-contain" loading="lazy"/><span>Editor</span>
    </a>
    <a href="projects.html" class="flex flex-col items-center gap-1 text-[11px] text-white/70">
      <img src="home_assets/Project_icon.svg" alt="Projects" class="w/[24px] h/[24px] object-contain" loading="lazy"/><span>Projects</span>
    </a>
    <a href="graph.html" class="flex flex-col items-center gap-1 text-[11px] text-white/70">
      <img src="home_assets/Graph_icon.svg" alt="Graph" class="w/[24px] h/[24px] object-contain opacity-70" loading="lazy"/><span>Graph</span>
    </a>
    <a href="social.html" class="flex flex-col items-center gap-1 text-[11px] text-white/70">
      <img src="home_assets/Social_icon.svg" alt="Social" class="w/[24px] h/[24px] object-contain" loading="lazy"/><span>Social</span>
    </a>
  </nav>

  <!-- ì¢Œì¸¡ ëª©ì°¨ -->
  <aside id="noteCol" class="hidden md:flex flex-col shrink-0">
    <div class="note-head"><span id="noteHeadTitle">ëª©ì°¨ â€” All Projects</span></div>
    <div class="note-scroll"><div id="tocRoot" class="toc-tree"></div></div>
    <div class="note-footer">
      <button id="linkBtn" class="w-full h-[38px] rounded-[10px] bg-[#0B0B0E] text-white text-[13px] flex items-center justify-center">ë…¸íŠ¸ ì—°ê²°í•˜ê¸°</button>
    </div>
  </aside>

  <!-- ì¤‘ì•™ -->
  <main class="center-wrap">
    <div class="doc-topbar">
      <input id="docTitle" class="doc-title" placeholder="write title" />
      <div class="doc-actions">
        <span>ìŠ¤í”Œë¦¿ ë·° <span class="chip">ON</span></span>
        <button id="manualSave" class="underline">ì €ì¥</button>
      </div>
    </div>

    <div class="toolbar-wrap">
      <div class="tag-row" id="tagRow">
        <button id="addTagBtn" class="tag-add">+ íƒœê·¸ ì¶”ê°€</button>
      </div>
      <div class="toolbar-row">
        <!-- âœ… ë‚¨ê²¨ë‘” ë²„íŠ¼: êµµê²Œ/ê¸°ìš¸ê¸°/ë°‘ì¤„/í‘œ/ì´ë¯¸ì§€ -->
        <button class="tbtn" data-cmd="bold"><b>B</b></button>
        <button class="tbtn" data-cmd="italic"><i>I</i></button>
        <button class="tbtn" data-cmd="underline"><u>U</u></button>
        <button class="tbtn" id="tableBtn">â–¦ í‘œ</button>
        <button class="tbtn" id="imgBtn">ğŸ–¼ï¸</button>
        <input id="imgFile" type="file" accept="image/*" multiple style="display:none"/>
      </div>
    </div>

    <div id="editorArea" class="editor-area">
      <div id="pageRoot" class="page-root editor-placeholder"></div>
    </div>

    <div class="editor-footer" style="border-top:1px solid var(--divider); height:44px; display:flex; align-items:center; justify-content:space-between; padding:0 12px; background:#fff; position:sticky; bottom:0; z-index:2;">
      <div class="flex items-center gap-2">
        <button class="icon-btn" title="ì¦ê²¨ì°¾ê¸°">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.5"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
        </button>
        <button class="icon-btn" title="ì²¨ë¶€" id="attachBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.5"><path d="M21.44 11.05l-9.19 9.19a5 5 0 01-7.07-7.07l9.19-9.19a3 3 0 014.24 4.24l-9.2 9.19a1 1 0 01-1.41-1.41l8.49-8.49"/></svg>
        </button>
      </div>
      <button class="icon-btn" title="ë³´ë‚´ê¸°">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.5"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
      </button>
    </div>
  </main>

  <!-- ìš°ì¸¡ -->
  <aside class="right-col">
    <div class="tabs">
      <button id="tab-chat" class="tab" aria-selected="false" aria-controls="panel-chat">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.5"><path d="M21 15a4 4 0 01-4 4H7l-4 4V7a4 4 0 014-4h10a4 4 0 014 4z"/></svg>
        <span>ì±—ë´‡</span>
      </button>
      <button id="tab-memo" class="tab" aria-selected="true" aria-controls="panel-memo">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.5"><path d="M9 12h6M9 16h6M8 4h8a2 2 0 012 2v12l-4 4H8a2 2 0 01-2-2V6a2 2 0 012-2z"/></svg>
        <span>ë©”ëª¨</span>
      </button>
      <button id="tab-reco" class="tab" aria-selected="false" aria-controls="panel-reco">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.5"><path d="M12 2l3 7 7 .5-5 5 1.5 7L12 18 5.5 21 7 14 2 9.5 9 9z"/></svg>
        <span>ì¶”ì²œ</span>
      </button>
    </div>

    <!-- ì±—ë´‡ -->
    <section id="panel-chat" class="panel" role="tabpanel">
      <div class="chat-log" id="chatLog"></div>
      <div class="chat-ctl">
        <div class="flex gap-6 items-center">
          <button id="chatLoadOlder" class="small-btn">ì´ì „ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="chatExport" class="small-btn">ë‚´ë³´ë‚´ê¸°(JSON)</button>
          <button id="chatClear" class="small-btn">ë¹„ìš°ê¸°</button>
        </div>
        <div class="chat-stats" id="chatStats">0 / 0</div>
      </div>
      <div class="chat-bar">
        <input id="chatInput" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."/>
        <button id="chatSend" class="send-btn" title="ì „ì†¡">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.5"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
        </button>
      </div>
    </section>

    <!-- ë©”ëª¨ -->
    <section id="panel-memo" class="panel" data-active="true" role="tabpanel">
      <!-- ë©”ëª¨ ë„êµ¬ì˜ì—­: ê²€ìƒ‰ + Add memo + write anything -->
      <div class="memo-tools">
        <input id="memoSearch" class="memo-search" placeholder="ë©”ëª¨ ê²€ìƒ‰"/>
        <button id="memoAddTop" class="memo-add">Add memo</button>
      </div>
      <div class="memo-quick">
        <div class="hint">write anything...</div>
        <textarea id="memoQuickInput" class="memo-input" placeholder="write anything... (Ctrl+Enter ë¡œ ì¶”ê°€)"></textarea>
        <div class="mt-2 flex justify-end"><button id="memoQuickAdd" class="memo-add">Add memo</button></div>
      </div>

      <div id="memoScroll" class="memo-scroll">
        <div>
          <div class="memo-sect-head">BMC ìš”ì•½ (ì½ê¸° ì „ìš©)</div>
          <div id="bmcGrid" class="bmc-grid"></div>
        </div>
        <div>
          <div class="memo-sect-head">ë‚´ ë©”ëª¨</div>
          <div id="userMemoList" class="memo-grid"></div>
        </div>
      </div>

      <div class="memo-bar">
        <div class="memo-info">BMCëŠ” ì½ê¸° ì „ìš© Â· ë‚´ ë©”ëª¨ëŠ” ìë™ ì €ì¥</div>
        <button id="memoAddBtn" class="memo-add">+ ë©”ëª¨ ì¶”ê°€</button>
      </div>
    </section>

    <!-- ì¶”ì²œ -->
    <section id="panel-reco" class="panel" role="tabpanel">
      <div id="recoWrap" class="bmc-card">
        <div class="bmc-title">ì¶”ì²œ ë…¸íŠ¸</div>
        <div id="recoList" class="reco-list"></div>
        <div id="recoInfo" class="text-[12px] text-[#6B7280] mt-2"></div>
        <div class="mt-3 flex justify-end">
          <button id="recoRefresh" class="memo-add">ì¬ê³„ì‚°</button>
        </div>
      </div>
    </section>
  </aside>

  <!-- ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì € & í€µíˆ´ -->
  <div id="imgResizer"></div>
  <div id="imgToolbar">
    <button class="btn" data-act="in">ï¼‹</button>
    <button class="btn" data-act="out">ï¼</button>
    <button class="btn" data-act="fit">=</button>
  </div>

  <!-- í‘œ + ë²„íŠ¼(ë…¸ì…˜ì‹) -->
  <div id="tblAddColBtn" class="tbl-plus-btn" title="ì—´ ì¶”ê°€">+</div>
  <div id="tblAddRowBtn" class="tbl-plus-btn" title="í–‰ ì¶”ê°€">+</div>

  <script>
    /* ===== Polyfills ===== */
    (function(){
      if (typeof window.CSS === "undefined") window.CSS = {};
      if (!window.CSS.escape){
        window.CSS.escape = function(value){
          if (arguments.length === 0) throw new TypeError('`CSS.escape` requires an argument.');
          var string = String(value); var length = string.length; var index = -1; var codeUnit, result = ''; var firstCodeUnit = string.charCodeAt(0);
          while (++index < length){
            codeUnit = string.charCodeAt(index);
            if (codeUnit === 0x0000){ result += "\uFFFD"; continue; }
            if ((codeUnit >= 0x0001 && codeUnit <= 0x001F) || codeUnit === 0x007F || (index === 0 && codeUnit >= 0x0030 && codeUnit <= 0x0039) || (index === 1 && codeUnit >= 0x0030 && codeUnit <= 0x0039 && firstCodeUnit === 0x002D)){
              result += "\\" + codeUnit.toString(16) + " "; continue;
            }
            if (index === 0 && codeUnit === 0x002D && length === 1){ result += "\\" + string.charAt(index); continue; }
            if (codeUnit >= 0x0080 || codeUnit === 0x002D || codeUnit === 0x005F || (codeUnit >= 0x0030 && codeUnit <= 0x0039) || (codeUnit >= 0x0041 && codeUnit <= 0x005A) || (codeUnit >= 0x0061 && codeUnit <= 0x007A)){
              result += string.charAt(index); continue;
            }
            result += "\\" + string.charAt(index);
          }
          return result;
        };
      }
    })();

    const rIC = window.requestIdleCallback || function(cb){ return setTimeout(cb, 1); };

    /* ===== Keys/State ===== */
    const CHAT_API_URL = 'http://localhost:3000/api/chat';
    const LIST_KEY='fw_projects', DRAFT_KEY='fw_project_draft_v2', LAST_ID_KEY='fw_last_project_id', LAST_NODE_GLOBAL='fw_last_node_global';
    function MEMO_KEY(pid){ return `fw_user_memos_${pid}`; }
    function docsKey(pid){ return `fw_docs_${pid}`; }
    function lastNodeKey(pid){ return `fw_last_node_${pid}`; }
    function tagKeyFor(pid, pathSub){ return `fw_editor_tags_${pid}::${pathSub}`; }
    function tocStateKey(pid){ return `fw_toc_state_${pid}`; }
    function tocOrderKey(parentPath){ return `fw_toc_order::${parentPath}`; } // âœ… DnD ìˆœì„œ ì €ì¥ í‚¤

    let CURRENT_PROJECT=null, CURRENT_PID=null, CURRENT_NODE_PATH=null, SUSPEND_SAVE=0;
    const PAGE = { enabled:true, pendingReflow:false };
    let MEMO_FILTER='';

    /* ===== Utils ===== */
    function safeParse(json, fb){ try{ const v=JSON.parse(json); return (v==null)?fb:v; }catch(_){ return fb; } }
    function htmlToText(html){ const tmp=document.createElement('div'); tmp.innerHTML=html||''; return (tmp.textContent||'').trim(); }
    function escapeHTML(t){ return String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function textToHTML(t){ return escapeHTML(t||'').replace(/\n/g,'<br/>'); }
    function toastOnce(msg){ if(!window.toast) return alert(msg); window.toast(msg); }
    function getProjectList(){ return safeParse(localStorage.getItem(LIST_KEY), []); }
    function getDraft(){ return safeParse(localStorage.getItem(DRAFT_KEY), null); }
    function getProjectById(pid){ const list=getProjectList(); return list.find(p=>p?.id===pid) || (getDraft()?.id===pid ? getDraft() : null); }
    function splitFullPath(full){ const i=full.indexOf('::'); if(i<0) return [CURRENT_PID, full]; return [full.slice(0,i), full.slice(i+2)]; }

    /* ===== Sidebar ===== */
    function initSidebar(){
      const sidebar=document.getElementById('sidebar');
      const collapseToggle=document.getElementById('collapseToggle');
      const brandToggleArea=document.getElementById('brandToggleArea');
      collapseToggle?.addEventListener('click', ()=>{ sidebar.setAttribute('data-collapsed','true'); applyAutoScale(); });
      brandToggleArea?.addEventListener('click', ()=>{ if(sidebar.getAttribute('data-collapsed')==='true'){ sidebar.setAttribute('data-collapsed','false'); applyAutoScale(); }});
    }

    /* ===== TOC ===== */
    const BMC_LABELS=[['cs','ê³ ê° ì„¸ë¶„í™”'],['cr','ê³ ê° ê´€ê³„'],['ch','ì±„ë„'],['rs','ìˆ˜ìµ ëª¨ë¸'],['vp','ê°€ì¹˜ ì œì•ˆ'],['ka','í•µì‹¬ í™œë™'],['kr','í•µì‹¬ ìì›'],['kp','í•µì‹¬ íŒŒíŠ¸ë„ˆ'],['cst','ë¹„ìš© êµ¬ì¡°']];

    function buildTocNodesForProject(p){
      const pid=p.id, title=(p?.title||'ë¬´ì œ í”„ë¡œì íŠ¸').trim(), psst=p?.psst||{};
      const trim=(s)=> (String(s||'').replace(/\s+/g,' ').trim()||'â€”').slice(0,50);
      const root={ pid, path:`${pid}::project`, type:'project', title:`${title}`, children:[] };
      const psGroup={ pid, path:`${pid}::psst`, type:'psst', title:'PSST', isFolder:true, children:[
        { pid, path:`${pid}::psst/p`,  type:'psstP', title:`P: ${trim(psst.p)}`,  children:[] },
        { pid, path:`${pid}::psst/s1`, type:'psstS', title:`S: ${trim(psst.s1 ?? psst.s)}`, children:[] },
        { pid, path:`${pid}::psst/s2`, type:'psstS', title:`S: ${trim(psst.s2)}`, children:[] },
        { pid, path:`${pid}::psst/t`,  type:'psstT', title:`T: ${trim(psst.t)}`,  children:[] },
      ]};
      root.children.push(psGroup);
      root.children.push({ pid, path:`${pid}::background`, type:'background', title:`ë°°ê²½`, children:[] });
      return [root];
    }
    function buildAllTocNodes(){
      const nodes=[], list=getProjectList(); list.forEach(p=> nodes.push(...buildTocNodesForProject(p)));
      const d=getDraft(); if(d && !list.find(x=>x.id===d.id)){ nodes.push(...buildTocNodesForProject(d)); }
      return nodes;
    }

    function orderChildrenIfSaved(node){
      // í˜„ì¬ëŠ” PSST í´ë” í•˜ìœ„ë§Œ ì •ë ¬ ì €ì¥
      if(node.path && node.path.endsWith('::psst') && node.children && node.children.length){
        const saved = safeParse(localStorage.getItem(tocOrderKey(node.path)), []);
        if(Array.isArray(saved) && saved.length){
          const index = new Map(saved.map((sub,i)=> [sub, i]));
          node.children.sort((a,b)=>{
            const sa = index.get(a.path.split('::')[1]) ?? 9999;
            const sb = index.get(b.path.split('::')[1]) ?? 9999;
            return sa - sb;
          });
        }
      }
    }

    function renderTocTree(nodes){
      const root=document.getElementById('tocRoot'); if(!root) return; root.innerHTML='';
      function badgeText(t){ const m={ project:'Project', psst:'PSST', background:'BG', psstP:'P', psstS:'S', psstT:'T' }; return m[t]||t; }

      function buildItem(node){
        const hasChildren=!!(node.children&&node.children.length), isFolder=!!node.isFolder || node.type==='psst';
        // ì •ë ¬ ì ìš©
        if(isFolder) orderChildrenIfSaved(node);

        const box=document.createElement('div'); box.className='node'; box.dataset.path=node.path; box.dataset.type=node.type; box.dataset.pid=node.pid;

        // âœ… PSST í•˜ìœ„ í•­ëª©ë§Œ ë“œë˜ê·¸ ê°€ëŠ¥
        const isPsstChild = node.path.includes('::psst/') && !isFolder;
        if(isPsstChild){
          box.setAttribute('draggable','true');
          box.dataset.draggable='true';
          box.dataset.parent=`${node.pid}::psst`;
          box.dataset.sub=node.path.split('::')[1]; // psst/p
        }

        if(CURRENT_NODE_PATH===node.path) box.classList.add('is-active');
        const caretEl=document.createElement('span'); caretEl.className='caret'; caretEl.textContent=hasChildren?( (safeParse(localStorage.getItem(tocStateKey(node.pid)),{})[node.path]===false)?'â–¸':'â–¾') :'Â·';
        const badgeEl=document.createElement('span'); badgeEl.className='badge'; badgeEl.textContent=badgeText(node.type);
        const titleEl=document.createElement('span'); titleEl.className='title'; titleEl.textContent=node.title||'(ì œëª©ì—†ìŒ)';
        box.appendChild(caretEl); box.appendChild(badgeEl); box.appendChild(titleEl);

        const wrapEl=document.createElement('div'); wrapEl.className='toc-item';
        const liEl=document.createElement('div'); liEl.className='toc-li'; liEl.appendChild(box);

        const state=safeParse(localStorage.getItem(tocStateKey(node.pid)),{}), expanded=state[node.path]!==false;
        if(hasChildren){
          const childrenWrap=document.createElement('div'); childrenWrap.className='toc-children';
          const ulEl=document.createElement('div'); ulEl.className='toc-ul';
          if(expanded){
            node.children.forEach(ch=> ulEl.appendChild(buildItem(ch)));
          }
          childrenWrap.appendChild(ulEl); liEl.appendChild(childrenWrap);
        }
        if(!expanded) liEl.parentElement?.classList?.add('is-collapsed');
        wrapEl.appendChild(liEl);

        // í´ë¦­/í† ê¸€
        box.addEventListener('click', (ev)=>{
          const clickOnCaret=(ev.offsetX<=22);
          if(hasChildren && (clickOnCaret || isFolder)){
            const state=safeParse(localStorage.getItem(tocStateKey(node.pid)),{})||{};
            const collapsed = (state[node.path]!==false) ? true : false;
            state[node.path]=!collapsed; localStorage.setItem(tocStateKey(node.pid), JSON.stringify(state));
            rerenderToc();
          }else{
            openNodeDocument(node.path, node.title, node.pid);
            document.querySelectorAll('.node.is-active').forEach(n=> n.classList.remove('is-active'));
            box.classList.add('is-active');
          }
        });

        return wrapEl;
      }

      nodes.forEach(n=> root.appendChild(buildItem(n)));

      // âœ… DnD ì´ë²¤íŠ¸ ìœ„ì„(PSST í•˜ìœ„)
      initTocDragAndDrop();
    }

    function initTocDragAndDrop(){
      const root=document.getElementById('tocRoot'); if(!root) return;
      let drag = null;
      root.addEventListener('dragstart', (e)=>{
        const tgt=e.target.closest('.node[data-draggable="true"]'); if(!tgt) return;
        drag = { parent:tgt.dataset.parent, sub:tgt.dataset.sub, el:tgt };
        tgt.classList.add('dragging');
        e.dataTransfer.effectAllowed='move';
      });
      root.addEventListener('dragend', (e)=>{
        const el=root.querySelector('.node.dragging'); if(el) el.classList.remove('dragging');
        root.querySelectorAll('.drop-marker-before,.drop-marker-after').forEach(n=> n.classList.remove('drop-marker-before','drop-marker-after'));
        drag=null;
      });
      root.addEventListener('dragover', (e)=>{
        if(!drag) return;
        const tgt=e.target.closest('.node[data-parent]'); if(!tgt) return;
        if(tgt.dataset.parent!==drag.parent) return;
        if(tgt.dataset.sub===drag.sub) return;
        e.preventDefault();
        const rect=tgt.getBoundingClientRect();
        const before = (e.clientY < rect.top + rect.height/2);
        root.querySelectorAll('.drop-marker-before,.drop-marker-after').forEach(n=> n.classList.remove('drop-marker-before','drop-marker-after'));
        tgt.classList.add(before?'drop-marker-before':'drop-marker-after');
      });
      root.addEventListener('drop', (e)=>{
        if(!drag) return;
        const tgt=e.target.closest('.node[data-parent]'); if(!tgt) return;
        if(tgt.dataset.parent!==drag.parent) return;
        if(tgt.dataset.sub===drag.sub) return;
        e.preventDefault();
        const parentPath = drag.parent; // e.g., "<pid>::psst"
        const before = tgt.classList.contains('drop-marker-before');

        // í˜„ì¬ ìˆœì„œ í™•ë³´ (DOM ê¸°ì¤€)
        const siblings = Array.from(root.querySelectorAll(`.node[data-parent="${CSS.escape(parentPath)}"]`));
        let order = siblings.map(n=> n.dataset.sub);

        // ë“œë˜ê·¸ í•­ëª© ì œê±°
        order = order.filter(x=> x!==drag.sub);
        // íƒ€ê²Ÿ ìœ„ì¹˜ ê³„ì‚°
        const idx = order.indexOf(tgt.dataset.sub);
        const insertAt = before ? idx : idx+1;
        order.splice(insertAt, 0, drag.sub);

        localStorage.setItem(tocOrderKey(parentPath), JSON.stringify(order));
        rerenderToc();
      });
    }

    function rerenderToc(){
      renderTocTree(buildAllTocNodes());
      const active=document.querySelector(`.node[data-path="${CSS.escape(CURRENT_NODE_PATH||'')}"]`);
      if(active){ document.querySelectorAll('.node.is-active').forEach(n=> n.classList.remove('is-active')); active.classList.add('is-active'); }
    }

    /* ===== Docs ===== */
    function loadDocsMap(pid){ return safeParse(localStorage.getItem(docsKey(pid)),{}); }
    function saveDocsMap(pid,map){ localStorage.setItem(docsKey(pid), JSON.stringify(map||{})); }
    function persistProject(){
      try{
        if(!CURRENT_PID || !CURRENT_PROJECT) return;
        const d=getDraft();
        if(d && d.id===CURRENT_PID){
          localStorage.setItem(DRAFT_KEY, JSON.stringify({ ...d, ...CURRENT_PROJECT, savedAt:new Date().toISOString() }));
        }
        const list=getProjectList();
        const idx=list.findIndex(x=> x && x.id===CURRENT_PID);
        if(idx>=0){
          list[idx]={ ...list[idx], ...CURRENT_PROJECT, savedAt:new Date().toISOString() };
          localStorage.setItem(LIST_KEY, JSON.stringify(list));
        }
        localStorage.setItem(LAST_ID_KEY, CURRENT_PID);
      }catch(e){ console.error(e); }
    }

    /* ===== Editor refs ===== */
    const editor={ pageRoot:null, title:null, saveBtn:null, tagRow:null, addTagBtn:null };

    function defaultDocHtml(title){
      const h=(t)=> (t||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      return `<section class="page" contenteditable="true"><h2>${h(title||'')}</h2>\n<p></p></section>`;
    }
    function psstInitialHtmlFor(subpath, project){
      const key=subpath.split('/')[1];
      const label={p:'Problem', s1:'Solution', s2:'Strategy', t:'Timeline'}[key]||'PSST';
      const val=(project?.psst?.[key]||'').trim();
      return `<section class="page" contenteditable="true"><h2>${label}</h2>\n<p>${textToHTML(val)}</p></section>`;
    }
    function ensureAtLeastOnePage(){
      const root=editor.pageRoot; if(!root) return;
      if(!root.querySelector('.page')){
        const sec=document.createElement('section');
        sec.className='page'; sec.setAttribute('contenteditable','true');
        root.appendChild(sec);
      }
      root.dataset.pageView = PAGE.enabled ? 'true' : 'false';
      root.classList.remove('editor-placeholder');
      if(root.querySelectorAll('.page').length===1 && root.querySelector('.page').innerHTML.trim()===''){
        root.classList.add('editor-placeholder');
      }
    }

    function updateNoteHead(){
      const el=document.getElementById('noteHeadTitle');
      if(el && CURRENT_PROJECT){ el.textContent = 'ëª©ì°¨ â€” ' + (CURRENT_PROJECT.title || 'ë¬´ì œ í”„ë¡œì íŠ¸'); }
    }

    function openNodeDocument(fullPath, displayTitle, pidFromNode){
      const [pid, sub]=splitFullPath(fullPath);
      const targetPid=pidFromNode||pid;
      if(sub==='psst'){ return; } // í´ë” ê°€ë“œ

      const proj=getProjectById(targetPid);
      if(!proj){ toastOnce('í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      CURRENT_PROJECT=proj; CURRENT_PID=targetPid;
      updateNoteHead();

      CURRENT_NODE_PATH=`${CURRENT_PID}::${sub}`;
      localStorage.setItem(LAST_ID_KEY, CURRENT_PID);
      localStorage.setItem(LAST_NODE_GLOBAL, CURRENT_NODE_PATH);
      localStorage.setItem(lastNodeKey(CURRENT_PID), CURRENT_NODE_PATH);

      const map=loadDocsMap(CURRENT_PID);
      if(!map[sub]){
        const isPS=sub.startsWith('psst/');
        const content=isPS ? psstInitialHtmlFor(sub, CURRENT_PROJECT) : defaultDocHtml(displayTitle || sub);
        map[sub]={ title:displayTitle || sub, html:content, type: sub.split('/')[0], updatedAt:new Date().toISOString() };
        saveDocsMap(CURRENT_PID, map);
        toastOnce('ìƒˆ ë¬¸ì„œë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤');
      }

      const doc=map[sub];
      editor.title.value=doc.title || '';
      editor.pageRoot.innerHTML=doc.html || '';
      ensureAtLeastOnePage();
      updatePageDividers();

      renderTagsFor(CURRENT_PID, sub);
      renderBmcCards();
      renderUserMemos();
      rerenderToc();
      if(PAGE.enabled) reflowPagesDeferred();
      applyAutoScale();
      scheduleRecommendationUpdate(); // ì¶”ì²œ ê°±ì‹ 
      clearImageSelection(); // ì´ë¯¸ì§€ ì„ íƒ ì´ˆê¸°í™”
      bindImageClickSelect(); // ìƒˆ DOMì— ì´ë¯¸ì§€ ë°”ì¸ë”©
    }

    function saveCurrentDoc(){
      if(SUSPEND_SAVE>0) return;
      if(!CURRENT_NODE_PATH || !CURRENT_PID) return;
      const [, sub]=splitFullPath(CURRENT_NODE_PATH);
      const map=loadDocsMap(CURRENT_PID);
      const doc=map[sub] || { title:'', html:'', type: sub.split('/')[0] };
      doc.title=editor.title.value || '';
      doc.html =editor.pageRoot.innerHTML || '';
      doc.updatedAt=new Date().toISOString();
      map[sub]=doc;
      saveDocsMap(CURRENT_PID, map);

      if(sub.startsWith('psst/')){
        const k=sub.split('/')[1];
        const firstPage=editor.pageRoot.querySelector('.page');
        const text=htmlToText(firstPage ? firstPage.innerHTML : doc.html);
        if(!CURRENT_PROJECT.psst) CURRENT_PROJECT.psst={};
        CURRENT_PROJECT.psst[k]=text;
        persistProject();
        rerenderToc();
      }

      if(editor.saveBtn){
        const old=editor.saveBtn.textContent;
        editor.saveBtn.textContent='ì €ì¥ë¨';
        setTimeout(()=> editor.saveBtn.textContent = old || 'ì €ì¥', 700);
      }
      scheduleRecommendationUpdate(); // ì¶”ì²œ ê°±ì‹ 
    }
    const autosave=(()=>{ let t=null; return ()=>{ if(SUSPEND_SAVE>0) return; clearTimeout(t); t=setTimeout(()=>{ saveCurrentDoc(); }, 400); }; })();

    /* ===== íƒœê·¸ ===== */
    function renderTagsFor(pid, subpath){
      const tagRow=editor.tagRow;
      const addBtn=editor.addTagBtn;
      Array.from(tagRow.querySelectorAll('.tag-pill')).forEach(n=> n.remove());
      const TAGS=safeParse(localStorage.getItem(tagKeyFor(pid, subpath)), []);
      TAGS.forEach((t,i)=>{
        const b=document.createElement('button');
        b.className='tag-pill'; b.textContent=t;
        b.addEventListener('click', ()=> b.classList.toggle('active'));
        b.addEventListener('dblclick', ()=>{
          const arr=safeParse(localStorage.getItem(tagKeyFor(pid, subpath)), []);
          arr.splice(i,1);
          localStorage.setItem(tagKeyFor(pid, subpath), JSON.stringify(arr));
          renderTagsFor(pid, subpath);
        });
        tagRow.insertBefore(b, addBtn);
      });
    }

    /* ===== Chat (ChatGPT API ì—°ë™) ===== */
    const CHAT_KEY = 'fw_editor_chat_log_v1';

    function loadChatLog() {
      return safeParse(localStorage.getItem(CHAT_KEY), []);
    }

    function saveChatLog(list) {
      localStorage.setItem(CHAT_KEY, JSON.stringify(list || []));
    }

    function updateChatStats() {
      const el = document.getElementById('chatStats');
      if (!el) return;
      const log = loadChatLog();
      const userCount = log.filter(m => m.role === 'user').length;
      const botCount  = log.filter(m => m.role === 'assistant').length;
      el.textContent = `${userCount} / ${botCount}`;
    }

    function appendChatBubble(role, text, { save = false } = {}) {
      const logEl = document.getElementById('chatLog');
      if (!logEl) return;

      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (role === 'user' ? 'me' : 'bot');
      bubble.textContent = text;
      logEl.appendChild(bubble);
      logEl.scrollTop = logEl.scrollHeight;

      if (save) {
        const log = loadChatLog();
        log.push({ role, text, ts: Date.now() });
        saveChatLog(log);
        updateChatStats();
      }

      return bubble;
    }

    function renderChatFromStore() {
      const logEl = document.getElementById('chatLog');
      if (!logEl) return;
      logEl.innerHTML = '';

      const log = loadChatLog();
      log.forEach(m => appendChatBubble(m.role, m.text, { save: false }));

      updateChatStats();
    }

    async function sendChatToApi(userText) {
      const logEl = document.getElementById('chatLog');
      if (!logEl) return;

      // 1) ì‚¬ìš©ì ë²„ë¸” ì¶”ê°€ + ì €ì¥
      appendChatBubble('user', userText, { save: true });

      // 2) ë¡œë”©ìš© ì„ì‹œ ë²„ë¸”
      const loadingBubble = appendChatBubble('assistant', 'ìƒê° ì¤‘...', { save: false });

      try {
        const docTitle = editor.title?.value || '';
        const docText  = htmlToText(editor.pageRoot?.innerHTML || '').slice(0, 4000);

        const messages = [
          {
            role: 'system',
            content: [
              'ë„ˆëŠ” FOR:WORD ì—ë””í„° ì•ˆì—ì„œ ì˜ˆë¹„ ì°½ì—…ì/ì‘ê°€/í•™ìƒì´ ì‘ì„± ì¤‘ì¸ ë¬¸ì„œë¥¼ ë„ì™€ì£¼ëŠ” í•œêµ­ì–´ ì½”íŒŒì¼ëŸ¿ì´ë‹¤.',
              'í•­ìƒ êµ¬ì¡°ì ìœ¼ë¡œ ì •ë¦¬í•´ì„œ ë‹µí•˜ê³ , ë¶ˆë¦¿/ë²ˆí˜¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ì ê·¹ì ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.',
              'ì‚¬ìš©ìì˜ ê¸€ì„ ë” ì„ ëª…í•˜ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë¬¸ì¥ìœ¼ë¡œ ë‹¤ë“¬ì–´ ì£¼ëŠ” ë° ì´ˆì ì„ ë‘”ë‹¤.'
            ].join(' ')
          },
          {
            role: 'user',
            content: [
              `í˜„ì¬ ë¬¸ì„œ ì œëª©: ${docTitle || '(ì œëª© ì—†ìŒ)'}`,
              docText ? `ë¬¸ì„œ ë‚´ìš©(ì¼ë¶€):\n${docText}` : '',
              '---',
              `ì§ˆë¬¸/ìš”ì²­:\n${userText}`
            ].join('\n\n')
          }
        ];

        const res = await fetch(CHAT_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages })
        });

        if (!res.ok) {
          throw new Error('API ì‘ë‹µ ì˜¤ë¥˜: ' + res.status);
        }

        const data = await res.json();
        const answer = data.reply || data.message || data.content || '';

        loadingBubble.textContent = answer || '(ë¹ˆ ì‘ë‹µ)';

        const log = loadChatLog();
        log.push({ role: 'assistant', text: loadingBubble.textContent, ts: Date.now() });
        saveChatLog(log);
        updateChatStats();

        logEl.scrollTop = logEl.scrollHeight;
      } catch (err) {
        console.error(err);
        loadingBubble.textContent = 'API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìª½ ë¡œê·¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.';
      }
    }

    function initChat() {
      const input   = document.getElementById('chatInput');
      const sendBtn = document.getElementById('chatSend');

      // ê¸°ì¡´ "ì´ì „ ë¶ˆëŸ¬ì˜¤ê¸° / ë‚´ë³´ë‚´ê¸° / ë¹„ìš°ê¸°" ë²„íŠ¼ì€ ìˆ¨ê¹€
      ['chatLoadOlder', 'chatExport', 'chatClear'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.style.display = 'none';
      });

      // ì €ì¥ë˜ì–´ ìˆë˜ ëŒ€í™” ë³µì›
      renderChatFromStore();

      function handleSend() {
        if (!input) return;
        const text = (input.value || '').trim();
        if (!text) return;
        input.value = '';
        sendChatToApi(text);
      }

      sendBtn?.addEventListener('click', handleSend);
      input?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      });
    }

    /* ===== Right tabs/chat/memo ===== */
    function initTabs(){
      const map=[['tab-chat','panel-chat'],['tab-memo','panel-memo'],['tab-reco','panel-reco']];

      function activate(id){
        map.forEach(([b,p])=>{
          const btn=document.getElementById(b);
          const pan=document.getElementById(p);
          const on=(b===id);
          btn && btn.setAttribute('aria-selected', on?'true':'false');
          pan && pan.setAttribute('data-active', on?'true':'false');
        });
        if(id==='tab-reco'){ scheduleRecommendationUpdate(); }
      }

      map.forEach(([b])=>{
        const btn=document.getElementById(b);
        btn && btn.addEventListener('click', ()=>activate(b));
      });

      activate('tab-memo'); // ê¸°ë³¸ í™œì„± íƒ­: ë©”ëª¨
    }

    function loadUserMemos(){ return safeParse(localStorage.getItem(MEMO_KEY(CURRENT_PID)), []); }
    function saveUserMemos(list){ localStorage.setItem(MEMO_KEY(CURRENT_PID), JSON.stringify(list||[])); }
    function autoGrow(ta){ if(!ta) return; const minPx=parseInt(getComputedStyle(ta).minHeight, 10) || 66; ta.style.height='auto'; ta.style.height=Math.max(ta.scrollHeight, minPx)+'px'; }
    function renderBmcCards(){
      const wrap=document.getElementById('bmcGrid'); if(!wrap) return;
      wrap.innerHTML='';
      const bmc=CURRENT_PROJECT?.bmc || {};
      BMC_LABELS.forEach(([k,label])=>{
        const card=document.createElement('div'); card.className='bmc-card';
        const title=document.createElement('div'); title.className='bmc-title'; title.textContent=label;
        const ro=document.createElement('div'); ro.className='bmc-ro';
        const val=(bmc?.[k] || '').trim();
        ro.innerHTML= val ? textToHTML(val) : '<span class="bmc-empty">â€”</span>';
        card.appendChild(title); card.appendChild(ro); wrap.appendChild(card);
      });
    }

    function renderUserMemos(focusLast=false){
      const listEl=document.getElementById('userMemoList'); if(!listEl) return;
      listEl.innerHTML='';
      const memos=loadUserMemos();
      const filter=(MEMO_FILTER||'').toLowerCase();
      let shown=0;

      memos.forEach((m, idx)=>{
        const text=(m.text||'');
        if(filter && text.toLowerCase().indexOf(filter)===-1) return;

        const card=document.createElement('div'); card.className='memo-card';
        const del =document.createElement('button'); del.className='memo-del'; del.textContent='ì‚­ì œ';
        del.addEventListener('click', ()=>{
          const cur=loadUserMemos();
          cur.splice(idx,1);
          saveUserMemos(cur);
          renderUserMemos();
        });
        const ta=document.createElement('textarea'); ta.className='memo-input'; ta.value=text;
        ta.addEventListener('input', ()=>{
          const cur=loadUserMemos();
          cur[idx]={ ...cur[idx], text:ta.value, updatedAt:Date.now() };
          saveUserMemos(cur);
          autoGrow(ta);
        });
        requestAnimationFrame(()=> autoGrow(ta));
        card.appendChild(del); card.appendChild(ta); listEl.appendChild(card); shown++;

        if(focusLast && idx===memos.length-1){
          setTimeout(()=>{
            ta.focus();
            ta.setSelectionRange(ta.value.length, ta.value.length);
          }, 0);
        }
      });

      if(shown===0){
        const emp=document.createElement('div'); emp.className='text-[12px] text-gray-500';
        emp.textContent = filter ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ì•„ì§ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ì˜ ì…ë ¥ì°½ì— ì ê³  Add memoë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.';
        listEl.appendChild(emp);
      }
    }
    function addUserMemo(){
      const memos=loadUserMemos();
      memos.push({ id:Date.now(), text:'', updatedAt:Date.now() });
      saveUserMemos(memos); renderUserMemos(true);
    }

    function initMemoUI(){
      const memoSearch=document.getElementById('memoSearch');
      memoSearch?.addEventListener('input', ()=>{
        MEMO_FILTER=(memoSearch.value||'').trim();
        renderUserMemos();
      });

      const addTop=document.getElementById('memoAddTop');
      addTop?.addEventListener('click', ()=> addUserMemo());

      const qi=document.getElementById('memoQuickInput');
      const qa=document.getElementById('memoQuickAdd');
      function quickAdd(){
        const val=(qi?.value||'').trim();
        if(!val){
          toastOnce('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
          return;
        }
        const memos=loadUserMemos();
        memos.push({ id:Date.now(), text:val, updatedAt:Date.now() });
        saveUserMemos(memos);
        qi.value='';
        renderUserMemos(true);
      }
      qa?.addEventListener('click', quickAdd);
      qi?.addEventListener('keydown', (e)=>{
        if((e.ctrlKey||e.metaKey) && e.key==='Enter') quickAdd();
      });
    }

    /* ===== Toolbar ===== */
    function initToolbar(){
      const root=editor.pageRoot;
      document.querySelectorAll('.tbtn[data-cmd]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          document.execCommand(btn.dataset.cmd, false, null);
          root && root.focus(); autosave(); if(PAGE.enabled) reflowPagesDeferred();
        });
      });
      document.getElementById('linkBtnEditor')?.addEventListener('click', ()=>{
        const url=prompt('ë§í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”'); if(!url) return;
        document.execCommand('createLink', false, url);
        root.focus(); autosave(); if(PAGE.enabled) reflowPagesDeferred();
      });
      const imgFile=document.getElementById('imgFile');
      document.getElementById('imgBtn')?.addEventListener('click', ()=>{ imgFile && imgFile.click(); });
      imgFile?.addEventListener('change', async (e)=>{
        if(!e.target.files || !e.target.files.length) return;
        await insertImageFiles(e.target.files);
        e.target.value='';
      });
      document.getElementById('codeBtn')?.addEventListener('click', ()=>{
        const sel=window.getSelection(); if(!sel || sel.rangeCount===0) return;
        const range=sel.getRangeAt(0); const span=document.createElement('code');
        span.textContent=sel.toString(); range.deleteContents(); range.insertNode(span);
        sel.removeAllRanges(); autosave(); if(PAGE.enabled) reflowPagesDeferred();
      });
      document.getElementById('pageViewBtn')?.addEventListener('click', ()=>{
        PAGE.enabled=!PAGE.enabled;
        editor.pageRoot.dataset.pageView = PAGE.enabled ? 'true' : 'false';
        updatePageDividers();
        if(PAGE.enabled){ reflowPagesDeferred(); }
        applyAutoScale();
        scheduleRecommendationUpdate();
      });
      document.getElementById('attachBtn')?.addEventListener('click', ()=> imgFile && imgFile.click());

      // âœ… í‘œ ì‚½ì…: ë…¸ì…˜ì‹ ê¸°ë³¸ 2Ã—2
      document.getElementById('tableBtn')?.addEventListener('click', ()=>{
        insertTableAtCaret(2,2);
        autosave(); if(PAGE.enabled) reflowPagesDeferred();
      });

      // ì´ë¯¸ì§€ í™•ëŒ€/ì¶•ì†Œ/ë§ì¶¤ (íˆ´ë°” ë²„íŠ¼ì€ ì œê±°ë˜ì—ˆì§€ë§Œ í€µíˆ´/í•¸ë“¤ë¡œ ì‚¬ìš© ê°€ëŠ¥)
      document.getElementById('imgZoomIn')?.addEventListener('click', ()=> nudgeSelectedImage(10));
      document.getElementById('imgZoomOut')?.addEventListener('click', ()=> nudgeSelectedImage(-10));
      document.getElementById('imgFit')?.addEventListener('click', ()=> fitSelectedImage());
    }

    /* ===== ì´ë¯¸ì§€ ì—…ë¡œë“œ/ë“œë¡­/ë¶™ì—¬ë„£ê¸° ===== */
    function caretSafeInsert(node){
      const sel=window.getSelection();
      if(!sel || sel.rangeCount===0){
        const first=editor.pageRoot.querySelector('.page') || editor.pageRoot;
        first.appendChild(node); return;
      }
      const range=sel.getRangeAt(0);
      range.collapse(false);
      range.insertNode(node);
      const r2=document.createRange();
      r2.setStartAfter(node); r2.setEndAfter(node);
      sel.removeAllRanges(); sel.addRange(r2);
    }
    function fileToDataURL(file){ return new Promise(resolve => { const fr=new FileReader(); fr.onload=()=> resolve(fr.result); fr.readAsDataURL(file); }); }
    async function insertImageFiles(fileList){
      const files=Array.from(fileList).filter(f=> /^image\//i.test(f.type));
      if(!files.length) return;
      SUSPEND_SAVE++;
      for(const f of files){
        const dataURL=await fileToDataURL(f);
        const img=document.createElement('img');
        img.src=dataURL; img.alt=f.name || 'image';
        img.style.maxWidth='100%'; img.style.height='auto';
        img.onload=()=>{ bindImageClickSelect(img); if(PAGE.enabled) reflowPagesDeferred(); };
        caretSafeInsert(img);
      }
      SUSPEND_SAVE--;
      autosave();
      if(PAGE.enabled) reflowPagesDeferred();
    }
    function initDragAndDrop(){
      const area=document.getElementById('editorArea');
      area.addEventListener('dragover', (e)=>{
        if(e.dataTransfer && [...(e.dataTransfer.items||[])].some(it=>it.kind==='file')){ e.preventDefault(); }
      });
      area.addEventListener('drop', async (e)=>{
        if(!e.dataTransfer) return;
        const files=e.dataTransfer.files;
        if(files && files.length){ e.preventDefault(); await insertImageFiles(files); }
      });
    }

    /* ===== ë¦¬ì¹˜ ë¶™ì—¬ë„£ê¸° ===== */
    function initRichPaste(){
      const root=editor.pageRoot;
      if(!root) return;
      root.addEventListener('paste', async (e) => {
        const cd=e.clipboardData || window.clipboardData; if(!cd) return;
        const types=cd.types ? Array.from(cd.types) : [];
        const hasHTML=types.includes('text/html');
        const hasImages=(cd.items ? Array.from(cd.items).some(it=> it.type && it.type.indexOf('image/')===0) : false);
        if(hasHTML || hasImages){
          e.preventDefault();
          SUSPEND_SAVE++;

          let html=hasHTML ? (cd.getData('text/html') || '') : '';
          if(html){
            html=extractBody(html);
            html=cleanPastedHTML(html);
            if(/(ê·¸ë¦¼ì…ë‹ˆë‹¤\.|ì›ë³¸ ê·¸ë¦¼ì˜ ì´ë¦„|This is a picture\.)/i.test(html)){ html=removeOfficeImagePlaceholders(html); }
            insertHTMLAtCaret(html);
          }
          if(hasImages){ await insertImagesFromClipboardItems(cd.items); }

          SUSPEND_SAVE--;
          autosave();
          if(PAGE.enabled) reflowPagesDeferred();
        }
      }, true);
    }
    async function insertImagesFromClipboardItems(items){
      const imgs=Array.from(items).filter(it=> it.type && it.type.indexOf('image/')===0);
      for(const it of imgs){
        const file=it.getAsFile && it.getAsFile(); if(!file) continue;
        await insertImageFiles([file]);
      }
    }
    function extractBody(html){ const m=/<body[^>]*>([\s\S]*?)<\/body>/i.exec(html); return m ? m[1] : html; }
    function cleanPastedHTML(html){
      html=html.replace(/<!--\[if[\s\S]*?<!\[endif\]-->/gi, '');
      html=html.replace(/<(script|style|title|meta|link|xml|iframe|object|embed|noscript)[\s\S]*?>[\s\S]*?<\/\1>/gi, '');
      html=html.replace(/<(script|style|title|meta|link|xml|iframe|object|embed|noscript)[^>]*?>/gi, '');
      html=html.replace(/<\/?o:p[^>]*>/gi, '');
      html=html.replace(/\s(on\w+)=(".*?"|'.*?'|[^\s>]+)/gi, '');
      html=html.replace(/<(v:|o:|w:)[^>]+>/gi, '');
      html=html.replace(/<\/(v:|o:|w:)[^>]+>/gi, '');
      html=html.replace(/<img([^>]+)src\s*=\s*"(file:[^"]+)"([^>]*)>/gi, '');
      return html;
    }
    function removeOfficeImagePlaceholders(html){
      return html.replace(/<p[^>]*>(\s|&nbsp;)*(ê·¸ë¦¼ì…ë‹ˆë‹¤\.|ì›ë³¸ ê·¸ë¦¼ì˜ ì´ë¦„|ì›ë³¸ ê·¸ë¦¼ì˜ í¬ê¸°|This is a picture\.)[\s\S]*?<\/p>/gi, '');
    }
    function insertHTMLAtCaret(html){
      const sel=window.getSelection();
      if(!sel || sel.rangeCount === 0){ document.execCommand('insertHTML', false, html); return; }
      const range=sel.getRangeAt(0);
      range.deleteContents();
      const temp=document.createElement('div'); temp.innerHTML=html;
      const frag=document.createDocumentFragment();
      while(temp.firstChild) frag.appendChild(temp.firstChild);
      range.insertNode(frag);
      sel.removeAllRanges();
      const r2=document.createRange();
      r2.setStartAfter(range.endContainer); r2.collapse(true);
      try{ sel.addRange(r2); }catch(_){}
    }

    /* ===== Pagination ===== */
    function updatePageDividers(){
      const root=editor.pageRoot; if(!root) return;
      Array.from(root.querySelectorAll('.page-divider')).forEach(n=>n.remove());
      const pages=Array.from(root.querySelectorAll('.page'));
      pages.forEach((p, i)=>{
        if(i < pages.length-1){
          const div=document.createElement('div');
          div.className='page-divider';
          div.innerHTML=`<div class="line"></div><div class="badge">â€” PAGE ${i+1} â€”</div>`;
          p.insertAdjacentElement('afterend', div);
        }
      });
    }
    function reflowPagesDeferred(){
      if(!PAGE.enabled) return;
      if(PAGE.pendingReflow) return;
      PAGE.pendingReflow=true;
      rIC(()=>{
        try{ reflowAllPages(); }
        finally{
          PAGE.pendingReflow=false;
          autosave();
          applyAutoScale();
        }
      });
    }
    function reflowAllPages(){
      const root=editor.pageRoot; if(!root) return;
      ensureAtLeastOnePage();
      Array.from(root.querySelectorAll('.page-divider')).forEach(n=>n.remove());
      const pages=Array.from(root.querySelectorAll('.page'));
      for(let i=0;i<pages.length;i++){ shiftOverflowDown(pages[i]); }
      for(let i=0;i<pages.length;i++){ pullUpIfSpace(pages[i]); }
      const all=Array.from(root.querySelectorAll('.page'));
      for(let i=all.length-1;i>0;i--){ if(all[i].innerHTML.trim()===''){ all[i].remove(); } }
      updatePageDividers();
    }
    function shiftOverflowDown(page){
      const MAX_LOOP=2000; let guard=0;
      while(page.scrollHeight > page.clientHeight + 1 && guard++ < MAX_LOOP){
        let next=page.nextElementSibling;
        if(!next || !next.classList.contains('page')){
          next=document.createElement('section'); next.className='page'; next.setAttribute('contenteditable','true');
          page.parentNode.insertBefore(next, page.nextSibling);
        }
        let last=page.lastChild; if(!last) break;
        if(last.nodeType === Node.TEXT_NODE){
          const p=document.createElement('p'); p.textContent=last.textContent; page.removeChild(last); page.appendChild(p); last=p;
        }
        if(last.nodeType !== Node.ELEMENT_NODE){ next.insertBefore(last, next.firstChild); continue; }
        if(last.tagName === 'IMG'){ next.insertBefore(last, next.firstChild); continue; }
        if(last.offsetHeight > page.clientHeight - 8){
          splitElementToNext(last, page, next);
          continue;
        }
        next.insertBefore(last, next.firstChild);
      }
    }
    function pullUpIfSpace(page){
      const next=page.nextElementSibling;
      if(!next || !next.classList.contains('page')) return;
      let safety=0;
      while(next.firstChild && (page.scrollHeight + (next.firstChild.offsetHeight||0)) <= page.clientHeight - 2 && safety++<2000){
        page.appendChild(next.firstChild);
      }
      if(next.innerHTML.trim()===''){ next.remove(); }
    }
    function splitElementToNext(el, page, next){
      if(el.childNodes && el.childNodes.length > 1){
        let safety=0;
        while(page.scrollHeight > page.clientHeight + 1 && el.lastChild && safety++<2000){
          const child=el.lastChild;
          if(child.nodeType===Node.TEXT_NODE){
            const p=document.createElement('p'); p.textContent=child.textContent; el.removeChild(child); el.appendChild(p);
            splitElementToNext(p, page, next);
          }else if(child.nodeType===Node.ELEMENT_NODE){
            if(child.tagName==='IMG'){ next.insertBefore(child, next.firstChild); }
            else if(child.offsetHeight > page.clientHeight - 8){ splitElementToNext(child, page, next); }
            else{ next.insertBefore(child, next.firstChild); }
          }else{
            next.insertBefore(child, next.firstChild);
          }
        }
        if(!el.childNodes.length){ el.remove(); }
        return;
      }
      if(el.childNodes.length === 1 && (el.firstChild.nodeType === Node.TEXT_NODE)){
        binarySplitTextElement(el, page, next);
        return;
      }
      next.insertBefore(el, next.firstChild);
    }
    function binarySplitTextElement(el, page, next){
      const full=el.textContent || '';
      if(!full.trim()){ next.insertBefore(el, next.firstChild); return; }
      let low=1, high=full.length, fit=0;
      const original=full;
      while(low<=high){
        const mid=(low+high)>>1;
        el.textContent=original.slice(0, mid);
        if(page.scrollHeight <= page.clientHeight){ fit=mid; low=mid + 1; }
        else { high=mid - 1; }
      }
      const rest=original.slice(fit);
      if(rest.length){
        const clone=el.cloneNode(false);
        clone.textContent=rest;
        next.insertBefore(clone, next.firstChild);
      }
    }

    /* ===== Toast ===== */
    function initToast(){
      const div=document.createElement('div');
      div.style.position='fixed'; div.style.left='50%'; div.style.bottom='24px'; div.style.transform='translateX(-50%)';
      div.style.padding='10px 14px'; div.style.border='1px solid #E5E7EB'; div.style.background='#fff'; div.style.borderRadius='10px';
      div.style.boxShadow='0 8px 24px rgba(0,0,0,.08)'; div.style.fontSize='13px'; div.style.color='#111827';
      div.style.display='none'; div.style.zIndex='9999';
      document.body.appendChild(div);
      window.toast=(msg)=>{ div.textContent=msg; div.style.display='block'; setTimeout(()=> div.style.display='none', 1200); };
    }

    /* ===== ì¤‘ì•™ íŒ¨ë„ í­ 95% ìë™ ìŠ¤ì¼€ì¼ëŸ¬ ===== */
    function applyAutoScale(){
      try{
        const root=editor.pageRoot, area=document.getElementById('editorArea');
        if(!root || !area) return;
        if(root.getAttribute('data-page-view')==='false'){
          document.documentElement.style.setProperty('--page-scale','1');
          return;
        }
        const page=root.querySelector('.page');
        if(!page){
          document.documentElement.style.setProperty('--page-scale','1');
          return;
        }

        const style=getComputedStyle(document.documentElement);
        const curScale=parseFloat(style.getPropertyValue('--page-scale'))||1;
        const baseWidthPx=page.offsetWidth / curScale;

        const avail = Math.max(0, area.clientWidth * 0.95);
        let s = avail / baseWidthPx;
        s = Math.max(1, Math.min(1.6, s));

        document.documentElement.style.setProperty('--page-scale', String(Math.round(s*1000)/1000));
      }catch(e){}
    }

    /* ===== ì¶”ì²œ(ë¡œì»¬ TF-IDF) ===== */
    let RECO_TIMER=null;
    function scheduleRecommendationUpdate(){
      clearTimeout(RECO_TIMER);
      RECO_TIMER=setTimeout(()=>{ rIC(computeAndRenderRecommendations); }, 250);
    }
    function getCurrentSub(){
      if(!CURRENT_NODE_PATH) return null;
      const [,sub]=splitFullPath(CURRENT_NODE_PATH);
      return sub;
    }
    function tokenize(s){
      return (s||'')
        .toLowerCase()
        .replace(/[^\p{L}\p{N}]+/gu,' ')
        .split(/\s+/)
        .filter(w=>w && w.length>=2);
    }
    function termFreq(tokens){
      const tf=new Map();
      tokens.forEach(t=> tf.set(t, (tf.get(t)||0)+1));
      return tf;
    }
    function buildIDF(docTokenLists){
      const N=docTokenLists.length;
      const df=new Map();
      docTokenLists.forEach(list=>{
        const uniq=new Set(list);
        uniq.forEach(t=> df.set(t, (df.get(t)||0)+1));
      });
      const idf=new Map();
      df.forEach((d,t)=> idf.set(t, Math.log((N+1)/(d+1))+1));
      return idf;
    }
    function toVector(tf,idf){
      const v=new Map();
      let norm=0;
      tf.forEach((f,t)=>{
        const w=(1+Math.log(f))*(idf.get(t)||0);
        if(w>0){
          v.set(t,w);
          norm+=w*w;
        }
      });
      return {v, norm:Math.sqrt(norm)};
    }
    function cosine(A,B){
      if(!A.norm || !B.norm) return 0;
      let dot=0;
      const [small,other] = A.v.size < B.v.size ? [A,B] : [B,A];
      small.v.forEach((wa,t)=>{
        const wb=other.v.get(t);
        if(wb) dot += wa*wb;
      });
      return dot/(A.norm*B.norm);
    }
    function splitSentences(text){
      return (text||'').split(/(?<=[\.!\?â€¦]|[ã€‚ï¼ï¼Ÿ]|[\.]{2,})\s+|\n+/g)
        .map(s=>s.trim())
        .filter(Boolean);
    }
    function bestSentenceFor(targetVec, idf, text){
      const sents=splitSentences(text).slice(0,200);
      let best={sent:'', score:0};
      for(const s of sents){
        const vec=toVector(termFreq(tokenize(s)), idf);
        const sc=cosine(targetVec, vec);
        if(sc>best.score) best={sent:s, score:sc};
      }
      return best;
    }
    function computeAndRenderRecommendations(){
      try{
        const wrap=document.getElementById('recoList');
        const info=document.getElementById('recoInfo');
        if(!wrap){ return; }
        wrap.innerHTML='';
        if(!CURRENT_PID){
          info.textContent='í”„ë¡œì íŠ¸ ì—†ìŒ';
          return;
        }

        const map=loadDocsMap(CURRENT_PID) || {};
        const curSub=getCurrentSub();
        if(!curSub || !map[curSub]){
          info.textContent='í˜„ì¬ ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
          return;
        }

        const curText=htmlToText(editor.pageRoot?.innerHTML || map[curSub].html || '');
        if(!curText || curText.length<10){
          info.textContent='í˜„ì¬ ë¬¸ì„œ ë‚´ìš©ì´ ì ì–´ ì¶”ì²œì´ ì–´ë ¤ì›Œìš”.';
          return;
        }

        const docs=[];
        Object.entries(map).forEach(([sub,doc])=>{
          const text=htmlToText(doc.html||'');
          if((text||'').trim() && sub!==curSub){
            docs.push({sub, title:doc.title||sub, text});
          }
        });
        if(!docs.length){
          info.textContent='ë¹„êµí•  ë‹¤ë¥¸ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.';
          return;
        }

        const curTokens=tokenize(curText);
        const otherTokens=docs.map(d=> tokenize(d.text));
        const idf=buildIDF([curTokens, ...otherTokens]);
        const curVec=toVector(termFreq(curTokens), idf);

        const scored=docs.map(d=>{
          const vec=toVector(termFreq(tokenize(d.text)), idf);
          const sim=cosine(curVec, vec);
          const best=bestSentenceFor(curVec, idf, d.text);
          return { ...d, score:sim, best };
        }).sort((a,b)=> b.score-a.score).slice(0,5);

        if(!scored.length){
          info.textContent='ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
          return;
        }
        scored.forEach(item=>{
          const li=document.createElement('div'); li.className='reco-item';
          const pct=Math.round(item.score*1000)/10;
          li.innerHTML=`
            <div class="reco-head">
              <div class="reco-title">${escapeHTML(item.title)}</div>
              <div class="reco-score">${pct.toFixed(1)}%</div>
            </div>
            <div class="reco-sent">${escapeHTML(item.best.sent || item.text.slice(0,120))}</div>
            <div class="reco-path">${escapeHTML(item.sub)}</div>
          `;
          li.addEventListener('click', ()=> openNodeDocument(`${CURRENT_PID}::${item.sub}`, item.title, CURRENT_PID));
          wrap.appendChild(li);
        });
        info.textContent = `ì´ ${docs.length}ê°œ ë¬¸ì„œ ì¤‘ ìƒìœ„ ${scored.length}ê°œë¥¼ ì¶”ì²œí–ˆìŠµë‹ˆë‹¤.`;
      }catch(e){
        console.error(e);
        const info=document.getElementById('recoInfo');
        if(info) info.textContent='ì¶”ì²œ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      }
    }

    /* ===== í‘œ ì‚½ì… & ë…¸ì…˜ì‹ + ë²„íŠ¼ ===== */
    function insertTableAtCaret(rows=2, cols=2){
      let html='<table><tbody>';
      for(let r=0;r<rows;r++){
        html+='<tr>';
        for(let c=0;c<cols;c++){ html+='<td><br/></td>'; }
        html+='</tr>';
      }
      html+='</tbody></table>';
      insertHTMLAtCaret(html);
    }

    const tblAddColBtn = document.getElementById('tblAddColBtn');
    const tblAddRowBtn = document.getElementById('tblAddRowBtn');
    let tblHover = null; // {table, tbody, cell, row, col}

    function cellInfoFromTarget(target){
      const cell = target.closest('td,th'); if(!cell) return null;
      const tr = cell.parentElement; if(!tr) return null;
      const tbody = tr.closest('tbody') || tr.parentElement;
      const table = tbody.closest('table');
      if(!table || !tbody) return null;
      const row = Array.from(tbody.rows).indexOf(tr);
      const col = cell.cellIndex;
      return { table, tbody, cell, row, col };
    }

    function positionTablePlusButtons(){
      if(!tblHover){
        tblAddColBtn.style.display='none';
        tblAddRowBtn.style.display='none';
        return;
      }
      const rect = tblHover.cell.getBoundingClientRect();
      // ì—´ + : ì…€ ìƒë‹¨ ì¤‘ì•™
      tblAddColBtn.style.left = (rect.left + rect.width/2 - 11) + 'px';
      tblAddColBtn.style.top  = (rect.top - 12) + 'px';
      // í–‰ + : ì…€ ì¢Œì¸¡ ì¤‘ì•™
      tblAddRowBtn.style.left = (rect.left - 12) + 'px';
      tblAddRowBtn.style.top  = (rect.top + rect.height/2 - 11) + 'px';
      tblAddColBtn.style.display='flex';
      tblAddRowBtn.style.display='flex';
    }

    function initTableOverlay(){
      const root=editor.pageRoot;
      if(!root) return;
      // í…Œì´ë¸” ìœ„ì—ì„œ ë§ˆìš°ìŠ¤ ì´ë™ ê°ì§€
      root.addEventListener('mousemove', (e)=>{
        const info = cellInfoFromTarget(e.target);
        if(!info){
          tblHover=null;
          positionTablePlusButtons();
          return;
        }
        tblHover = info;
        positionTablePlusButtons();
      });
      // ì˜ì—­ì„ ë²—ì–´ë‚˜ë©´ ìˆ¨ê¹€
      document.getElementById('editorArea').addEventListener('scroll', positionTablePlusButtons, {passive:true});
      window.addEventListener('resize', positionTablePlusButtons);

      // í´ë¦­: ì—´ ì¶”ê°€
      tblAddColBtn.addEventListener('click', ()=>{
        if(!tblHover) return;
        const { tbody, col } = tblHover;
        Array.from(tbody.rows).forEach(tr=>{
          const td=document.createElement('td'); td.innerHTML='<br/>';
          if(col >= tr.cells.length-1) tr.appendChild(td);
          else tr.insertBefore(td, tr.cells[col+1]);
        });
        autosave(); if(PAGE.enabled) reflowPagesDeferred();
        positionTablePlusButtons();
      });

      // í´ë¦­: í–‰ ì¶”ê°€
      tblAddRowBtn.addEventListener('click', ()=>{
        if(!tblHover) return;
        const { tbody, row } = tblHover;
        const ref = tbody.rows[row];
        const newRow=document.createElement('tr');
        const cols = ref ? ref.cells.length : 1;
        for(let i=0;i<cols;i++){
          const td=document.createElement('td'); td.innerHTML='<br/>';
          newRow.appendChild(td);
        }
        if(row >= tbody.rows.length-1) tbody.appendChild(newRow);
        else tbody.insertBefore(newRow, tbody.rows[row+1]);
        autosave(); if(PAGE.enabled) reflowPagesDeferred();
        positionTablePlusButtons();
      });

      // ì—ë””í„° ì˜ì—­ ë°– í´ë¦­ ì‹œ ìˆ¨ê¹€
      document.addEventListener('click', (e)=>{
        if(e.target===tblAddColBtn || e.target===tblAddRowBtn) return;
        if(!e.target.closest('table')){
          tblHover=null;
          positionTablePlusButtons();
        }
      });
    }

    /* ===== ì´ë¯¸ì§€ ì„ íƒ & ë¦¬ì‚¬ì´ì¦ˆ ===== */
    let selectedImage=null;
    const resizerEl=document.getElementById('imgResizer');
    const imgToolbar=document.getElementById('imgToolbar');
    const editorArea=document.getElementById('editorArea');

    function bindImageClickSelect(scope){
      const root=scope || editor.pageRoot;
      if(!root) return;
      root.querySelectorAll('img').forEach(img=>{
        if(img.__fw_bound) return;
        img.__fw_bound=true;
        img.addEventListener('click', (e)=>{
          e.stopPropagation();
          selectImage(img);
        });
        img.addEventListener('dblclick', ()=>{ fitImage(img); });
      });
    }
    function getContainerWidth(img){
      let el=img.parentElement;
      while(el && !el.classList.contains('page')){ el=el.parentElement; }
      const pad = parseFloat(getComputedStyle(el).paddingLeft||'0') + parseFloat(getComputedStyle(el).paddingRight||'0');
      return (el ? el.clientWidth - pad : img.parentElement.clientWidth || 1);
    }
    function getScale(img){
      const contW=getContainerWidth(img);
      const w=img.getBoundingClientRect().width;
      const pageScale=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-scale'))||1;
      const logicalW=w / pageScale;
      return Math.max(1, Math.round((logicalW/contW)*100));
    }
    function setScale(img, pct){
      pct=Math.min(100, Math.max(10, Math.round(pct)));
      img.style.width = pct + '%';
      img.style.height = 'auto';
      positionImgUI(); // move handle/toolbox
      autosave();
      if(PAGE.enabled) reflowPagesDeferred();
    }
    function fitImage(img){ setScale(img, 100); }
    function selectImage(img){
      clearImageSelection();
      selectedImage=img;
      img.classList.add('img-selected');
      positionImgUI();
      resizerEl.style.display='block';
      imgToolbar.style.display='flex';
    }
    function clearImageSelection(){
      if(selectedImage){ selectedImage.classList.remove('img-selected'); }
      selectedImage=null;
      resizerEl.style.display='none';
      imgToolbar.style.display='none';
    }
    function positionImgUI(){
      if(!selectedImage){
        resizerEl.style.display='none';
        imgToolbar.style.display='none';
        return;
      }
      const rect=selectedImage.getBoundingClientRect();
      // Resizer handle bottom-right
      resizerEl.style.left=(rect.right-6) + 'px';
      resizerEl.style.top =(rect.bottom-6) + 'px';
      // Toolbar top-right of image
      imgToolbar.style.left=(rect.right - 120) + 'px';
      imgToolbar.style.top =(rect.top - 40) + 'px';
      resizerEl.style.display='block';
      imgToolbar.style.display='flex';
    }
    // Drag to resize
    let dragState=null;
    resizerEl.addEventListener('pointerdown', (e)=>{
      if(!selectedImage) return;
      e.preventDefault();
      const contW=getContainerWidth(selectedImage);
      dragState={ startX:e.clientX, startW:selectedImage.getBoundingClientRect().width, contW };
      resizerEl.setPointerCapture(e.pointerId);
    });
    resizerEl.addEventListener('pointermove', (e)=>{
      if(!dragState || !selectedImage) return;
      const dx=e.clientX - dragState.startX;
      const newW=dragState.startW + dx;
      const pageScale=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-scale'))||1;
      const pct=(newW/pageScale)/dragState.contW*100;
      setScale(selectedImage, pct);
    });
    function endDrag(e){
      if(dragState){
        resizerEl.releasePointerCapture?.(e?.pointerId);
        dragState=null;
        autosave();
      }
    }
    resizerEl.addEventListener('pointerup', endDrag);
    resizerEl.addEventListener('pointercancel', endDrag);

    // Quick toolbar actions
    imgToolbar.addEventListener('click', (e)=>{
      const act=e.target?.dataset?.act;
      if(!act || !selectedImage) return;
      if(act==='in') nudgeSelectedImage(10);
      if(act==='out') nudgeSelectedImage(-10);
      if(act==='fit') fitSelectedImage();
    });
    function nudgeSelectedImage(delta){
      if(!selectedImage) return;
      const cur=getScale(selectedImage);
      setScale(selectedImage, cur+delta);
    }
    function fitSelectedImage(){ if(selectedImage) fitImage(selectedImage); }

    // Deselect on outside click
    document.addEventListener('click', (e)=>{
      const isImg = e.target && e.target.tagName==='IMG';
      const inToolbar = imgToolbar.contains(e.target);
      const inHandle = e.target===resizerEl;
      if(isImg || inToolbar || inHandle) return;
      clearImageSelection();
    });

    // Reposition handle on scroll/resize
    document.getElementById('editorArea').addEventListener('scroll', ()=>{
      positionImgUI();
      positionTablePlusButtons();
    }, {passive:true});
    window.addEventListener('resize', ()=>{
      positionImgUI();
      positionTablePlusButtons();
    });

    /* ===== Right panel actions ===== */
    document.addEventListener('click', (e)=>{
      if(e.target && e.target.id==='recoRefresh'){
        scheduleRecommendationUpdate();
      }
    });

    /* ===== Init ===== */
    function initNotePanelAndEditor(){
      const lastNodeGlobal=localStorage.getItem(LAST_NODE_GLOBAL);
      let initialProject=null;

      if(lastNodeGlobal){
        const [pid]=splitFullPath(lastNodeGlobal);
        const p=getProjectById(pid);
        if(p){ initialProject=p; }
      }
      if(!initialProject){
        const list=getProjectList();
        const lastPid=localStorage.getItem(LAST_ID_KEY);
        initialProject=(lastPid && getProjectById(lastPid)) || (list && list[0]) || getDraft() || null;
      }
      if(!initialProject){
        const root=document.getElementById('tocRoot');
        if(root){
          root.innerHTML='<div class="text-[13px] text-gray-500">ë³µì›í•  í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. Projectsì—ì„œ ìƒˆë¡œ ìƒì„±í•´ ì£¼ì„¸ìš”.</div>';
        }
        return;
      }

      CURRENT_PROJECT=initialProject;
      CURRENT_PID=initialProject.id;
      localStorage.setItem(LAST_ID_KEY, CURRENT_PID);
      updateNoteHead();

      rerenderToc();

      editor.pageRoot=document.getElementById('pageRoot');
      editor.title   =document.getElementById('docTitle');
      editor.saveBtn =document.getElementById('manualSave');
      editor.tagRow  =document.getElementById('tagRow');
      editor.addTagBtn=document.getElementById('addTagBtn');

      ensureAtLeastOnePage();
      updatePageDividers();

      editor.pageRoot.addEventListener('input', ()=>{
        if(PAGE.enabled) reflowPagesDeferred();
        autosave();
      });
      editor.title.addEventListener('input', ()=>{
        autosave();
        scheduleRecommendationUpdate();
      });
      editor.saveBtn?.addEventListener('click', saveCurrentDoc);

      editor.addTagBtn?.addEventListener('click', ()=>{
        if(!CURRENT_NODE_PATH){
          toastOnce('ë¨¼ì € ì¢Œì¸¡ ëª©ì°¨ì—ì„œ ë¬¸ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”');
          return;
        }
        const [, sub]=splitFullPath(CURRENT_NODE_PATH);
        const t=prompt('íƒœê·¸ ì…ë ¥'); if(!t) return;
        const arr=safeParse(localStorage.getItem(tagKeyFor(CURRENT_PID, sub)), []);
        arr.push(t);
        localStorage.setItem(tagKeyFor(CURRENT_PID, sub), JSON.stringify(arr));
        renderTagsFor(CURRENT_PID, sub);
      });

      const fallbackSub='psst/p';
      let startPath=lastNodeGlobal || `${CURRENT_PID}::${fallbackSub}`;
      if(startPath.endsWith('::psst')) startPath=`${CURRENT_PID}::${fallbackSub}`;
      openNodeDocument(startPath, lastNodeGlobal ? null : 'P');

      renderBmcCards();
      renderUserMemos();

      requestAnimationFrame(()=>{
        applyAutoScale();
        scheduleRecommendationUpdate();
        bindImageClickSelect();
        initTableOverlay();
      });
    }

    function initSidebarAndPanels(){
      initSidebar();
      initToast();
      initTabs();
      initChat();
      initMemoUI();
    }

    function initDragPasteAndToolbar(){
      initToolbar();
      initRichPaste();
      initDragAndDrop();
    }

    // ì¢Œì¸¡ í•˜ë‹¨ ë²„íŠ¼
    document.getElementById('linkBtn')?.addEventListener('click', ()=>{
      if(!CURRENT_NODE_PATH){
        toastOnce('ë¨¼ì € ì¢Œì¸¡ ëª©ì°¨ì—ì„œ ë¬¸ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”');
        return;
      }
      const [pid, sub]=splitFullPath(CURRENT_NODE_PATH);
      const linked={
        at: Date.now(),
        projectId: pid,
        node: sub,
        title: document.getElementById('docTitle').value || sub
      };
      localStorage.setItem('fw_linked_note', JSON.stringify(linked));
      toastOnce('ë…¸íŠ¸ë¥¼ ì—°ê²°í–ˆìŠµë‹ˆë‹¤.');
    });
    document.getElementById('memoAddBtn')?.addEventListener('click', ()=> addUserMemo());

    window.addEventListener('resize', ()=>{
      applyAutoScale();
      positionImgUI();
    });

    window.addEventListener('load', ()=>{
      initSidebarAndPanels();
      initNotePanelAndEditor();
      initDragPasteAndToolbar();
    });
  </script>
</body>
</html>
