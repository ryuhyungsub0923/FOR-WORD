<!-- =========================================================
FILE: editor.html
ìš”êµ¬ ë°˜ì˜:
- ì¤‘ì•™ íŒ¨ë„ ê°€ë¡œ ê½‰ ì°¨ê²Œ í‘œì‹œ(A4 ë¹„ìœ¨ ìœ ì§€, ìŠ¤ì¼€ì¼ ì ìš©)
- A4 ì„¸ë¡œ ì´ˆê³¼ ì‹œ ì‹¤ì œ DOM êµ¬ë¶„ì„ (.page-divider) ìë™ ì‚½ì…
- ì´ë¯¸ì§€/í‘œ í¬í•¨ ê¸´ ë¬¸ì„œë„ ìë™ ë¶„í• 
========================================================= -->
<!doctype html>
<html lang="ko" class="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FOR:WORD â€” Editor View</title>

  <!-- ê°œë°œìš©: Tailwind CDN (í”„ë¡œë•ì…˜ì€ CLI/PostCSS ê¶Œì¥) -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard@1.3.9/dist/web/static/pretendard.css"/>
  <script>
    window.tailwind = window.tailwind || {};
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { fontFamily: { sans: ['Pretendard','system-ui','sans-serif'] } } }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>

  <style>
    :root{
      --sb-nav-top: rgba(30,31,31,0.9);
      --sb-nav-bottom: #848C95;
      --sb-main-top: #2C2C2C;
      --sb-main-bottom: #929292;

      --sidebar-w: 212px;
      --sidebar-w-collapsed: 68px;
      --mobile-nav-h: 64px;

      --canvas-bg: #FFFFFF;
      --work-bg: #F7F7F8;
      --ink-1: #111827;
      --ink-2: #6B7280;
      --divider: #E5E7EB;

      --index-w: 260px;
      --right-w: 360px;
      --editor-min-h: 520px;
      --docbar-h: 56px;

      /* A4 ì‹¤ì œ í¬ê¸°(ê¸°ì¤€ ë‹¨ìœ„: mm) â€” ë‚´ë¶€ëŠ” ì´ í¬ê¸°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¶„í•  */
      --page-w: 210mm; /* A4 */
      --page-h: 297mm; /* A4 */
      --page-pad: 16mm;
      --page-gap: 10mm;
      --page-shadow: 0 8px 28px rgba(0,0,0,.10);
      --page-border: 1px solid #E5E7EB;
    }

    body{ overflow:hidden; color:var(--ink-1); }
    #noteCol, .center-wrap, .right-col{ content-visibility:auto; contain-intrinsic-size:800px 1000px; }

    /* ===== Sidebar (ê¸°ì¡´ ë””ìì¸ ìœ ì§€) ===== */
    .sidebar{ width:var(--sidebar-w); background:linear-gradient(to bottom, var(--sb-nav-top), var(--sb-nav-bottom)); transition:width .18s ease; }
    .sidebar[data-collapsed="true"]{ width:var(--sidebar-w-collapsed); }
    .brand-text{ font-size:18px; font-weight:600; color:#fff; letter-spacing:-0.02em; white-space:nowrap; }
    .sidebar[data-collapsed="true"] .brand-text{ display:none; }
    .brand-wrapper{ display:flex; align-items:center; justify-content:space-between; }
    .brand-left{ display:flex; align-items:center; gap:12px; cursor:pointer; }
    .sidebar[data-collapsed="true"] .brand-left{ justify-content:center; width:100%; gap:0!important; }
    .logo-wrapper{ width:32px; height:32px; border-radius:6px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .logo-wrapper img{ width:100%; height:100%; object-fit:contain; }
    .sidebar[data-collapsed="true"] .logo-wrapper{ display:none; }
    .expand-icon-wrapper{ width:32px; height:32px; border-radius:6px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); display:none; align-items:center; justify-content:center; }
    .sidebar[data-collapsed="true"] .expand-icon-wrapper{ display:flex; }
    .collapse-btn{ width:28px; height:28px; border-radius:6px; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); cursor:pointer; }
    .collapse-icon{ transition:transform .18s ease; }
    .sidebar[data-collapsed="true"] .collapse-icon{ transform:rotate(180deg); }
    .sidebar-nav-container{ display:flex; flex-direction:column; flex-grow:1; padding:24px 16px; }
    .sidebar[data-collapsed="true"] .sidebar-nav-container{ padding-left:10px; padding-right:10px; }
    .sidebar-nav-btn{ width:180px; height:48px; display:flex; align-items:center; gap:10px; border-radius:8px; padding:0 12px; color:inherit; text-decoration:none; transition:background .12s ease; }
    .sidebar-nav-btn:hover{ background:rgba(255,255,255,0.1); }
    .sidebar[data-collapsed="true"] .sidebar-nav-btn{ width:48px; justify-content:center; gap:0; padding:0; }
    .sidebar[data-collapsed="true"] .sidebar-nav-btn span.nav-label{ display:none; }
    .sidebar-divider{ border-top:1px solid rgba(255,255,255,0.15); margin:16px 0; }
    .main-bg{ background:linear-gradient(to bottom, var(--sb-main-top), var(--sb-main-bottom)); }
    .mobile-nav-bg{ background:linear-gradient(to bottom, var(--sb-nav-top), var(--sb-nav-bottom)); }

    /* ===== ì¢Œì¸¡ ëª©ì°¨(ê¸°ì¡´ ìœ ì§€) ===== */
    #noteCol{ width:var(--index-w); background:#fff; color:#0F172A; display:flex; flex-direction:column; border-right:1px solid var(--divider); height:100vh; }
    .note-head{ height:44px; display:flex; align-items:center; gap:6px; padding:0 10px; border-bottom:1px solid var(--divider); font-size:12px; color:#6B7280; }
    .note-scroll{ flex:1; overflow:auto; padding:10px; }
    .note-footer{ border-top:1px solid var(--divider); padding:10px; background:#fff; }
    .toc-tree{ font-size:13px; }
    .toc-ul{ list-style:none; margin:0; padding:0; }
    .toc-li{ margin:2px 0; }
    .node{ width:100%; display:flex; align-items:center; gap:6px; border:1px solid #E5E7EB; background:#fff; color:#0F172A; border-radius:8px; padding:6px 8px; cursor:pointer; user-select:none; }
    .node:hover{ background:#F8FAFC; }
    .node .caret{ width:16px; height:16px; display:flex; align-items:center; justify-content:center; color:#64748B; flex:0 0 16px; }
    .node .badge{ font-size:11px; padding:2px 6px; border-radius:6px; background:#EEF2FF; color:#1f2345; border:1px solid #E6E7FF; flex:0 0 auto; }
    .node .title{ flex:1 1 auto; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .toc-children{ margin:6px 0 6px 18px; }
    .is-active{ outline:2px solid #3655ff55; }
    .is-collapsed > .toc-children{ display:none; }

    /* ===== ì¤‘ì•™ ===== */
    .center-wrap{ flex:1 1 auto; min-width:0; background:var(--canvas-bg); display:flex; flex-direction:column; height:100vh; }
    .doc-topbar{ height:var(--docbar-h); display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--divider); padding:0 14px; background:var(--canvas-bg); position:sticky; top:0; z-index:5; }
    .doc-title{ font-size:14px; color:#999; outline:none; border:none; background:transparent; flex:1 1 auto; min-width:0; margin-right:8px; height:calc(var(--docbar-h) - 2px); line-height:calc(var(--docbar-h) - 2px); padding:0; }
    .doc-actions{ display:flex; align-items:center; gap:14px; font-size:12px; color:#374151; }
    .chip{ font-size:12px; padding:4px 8px; border-radius:999px; background:#111827; color:#fff; font-weight:700; }

    .toolbar-wrap{ border-bottom:1px solid var(--divider); background:#F9FAFB; }
    .tag-row{ height:40px; display:flex; align-items:center; gap:8px; padding:0 12px; }
    .tag-pill{ font-size:12px; border:1px solid #E5E7EB; background:#fff; padding:6px 10px; border-radius:999px; cursor:pointer; color:#374151; }
    .tag-pill.active{ background:#111827; color:#fff; border-color:#111827; }
    .tag-add{ font-size:12px; border:1px solid #E5E7EB; background:#fff; padding:6px 10px; border-radius:999px; cursor:pointer; color:#374151; }
    .toolbar-row{ display:flex; align-items:center; gap:10px; padding:10px 12px; }
    .tbtn{ height:28px; min-width:28px; padding:0 8px; border-radius:6px; border:1px solid #D1D5DB; background:#fff; display:flex; align-items:center; justify-content:center; gap:6px; font-size:13px; cursor:pointer; color:#111827; }
    .tsep{ height:28px; width:1px; background:#E5E7EB; margin:0 2px; }

    /* ì¤‘ì•™ ì—ë””í„° ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ: ê°€ë¡œ ê½‰ ì°¨ê²Œ */
    .editor-area{
      flex:1 1 auto; min-height:0; overflow:auto; background:#f7f7f8;
      padding:16px 12px 56px; /* ìƒÂ·ì¢Œìš°Â·í•˜ */
    }

    /* í˜ì´ì§€ ë£¨íŠ¸(ì—°ì† ë ˆì´ì•„ì›ƒ) */
    .page-root{
      min-height:calc(var(--editor-min-h) - 32px);
      display:flex; flex-direction:column; gap:0;
    }

    /* ìŠ¤ì¼€ì¼ ë˜í¼: ê°€ë¡œ í­ ê½‰ ì±„ìš°ê¸°(ë‚´ë¶€ .pageë¥¼ scale) */
    .page-outer{
      position:relative;
      width:100%;
      /* ë†’ì´ëŠ” JSê°€ ë‚´ë¶€ .page ë†’ì´Ã—scaleë¡œ ì„¤ì • */
      display:flex;
      justify-content:center;
    }

    /* ì‹¤ì œ A4 í˜ì´ì§€(ê¸°ì¤€ í¬ê¸°) */
    .page{
      position:relative;
      width:var(--page-w);
      min-height:var(--page-h);
      background:#fff; color:#111827;
      border:var(--page-border);
      box-shadow:var(--page-shadow);
      border-radius:10px;
      padding:var(--page-pad);
      margin:0;
      box-sizing:border-box;
      overflow:hidden;
      transform-origin:top center; /* ìŠ¤ì¼€ì¼ ê¸°ì¤€ */
    }

    /* ì‹¤ì œ DOM êµ¬ë¶„ì„  (í˜ì´ì§€ ì‚¬ì´) */
    .page-divider{
      width:100%; /* JSì—ì„œ ì‹¤ì œ ìŠ¤ì¼€ì¼ í­ìœ¼ë¡œ ë§ì¶°ì¤Œ */
      display:flex; flex-direction:column; align-items:center;
      margin: calc(var(--page-gap)/2) auto;
      user-select:none; pointer-events:none;
    }
    .page-divider .line{ width:100%; border-top:1px dashed #cbd5e1; }
    .page-divider .badge{ margin-top:6px; font-size:12px; color:#94a3b8; }

    /* ì½˜í…ì¸  ê·œì¹™ */
    .page *{ break-inside:auto; }
    .page p, .page li, .page blockquote{ line-height:1.8; font-size:14px; margin:0 0 10px 0; }
    .page h1{ font-size:24px; font-weight:800; margin:0 0 16px; }
    .page h2{ font-size:20px; font-weight:700; margin:14px 0; }
    .page h3{ font-size:16px; font-weight:700; margin:12px 0; }
    .page table{ width:100%; border-collapse:collapse; margin:10px 0; }
    .page th,.page td{ border:1px solid #e5e7eb; padding:6px 8px; font-size:13px; vertical-align:top; }
    .page img{ display:block; margin:8px auto; max-width:100%; height:auto; object-fit:contain; }

    /* ===== ìš°ì¸¡ ===== */
    .right-col{ width:var(--right-w); background:#FAFAFB; display:flex; flex-direction:column; height:100vh; border-left:1px solid var(--divider); color:#111827; }
    .tabs{ height:44px; display:flex; align-items:center; gap:8px; padding:0 10px; border-bottom:1px solid var(--divider); background:#FFFFFF; }
    .tab{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:8px; font-weight:600; font-size:13px; color:#374151; cursor:pointer; }
    .tab[aria-selected="true"]{ background:#F3F4F6; }
    .panel{ display:none; height:calc(100vh - 44px); }
    .panel[data-active="true"]{ display:flex; flex-direction:column; }

    .chat-log{ flex:1 1 auto; overflow:auto; padding:12px; }
    .bubble{ max-width:85%; border-radius:10px; padding:10px 12px; font-size:13px; line-height:1.55; }
    .bot{ background:#FFFFFF; border:1px solid #E5E7EB; color:#111827; margin-right:auto; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .me{ background:#111827; color:#fff; margin-left:auto; }
    .chat-ctl{ border-top:1px solid var(--divider); background:#fff; padding:6px 10px; display:flex; align-items:center; gap:8px; justify-content:space-between; }
    .small-btn{ height:28px; padding:0 10px; border:1px solid #D1D5DB; border-radius:8px; background:#fff; font-size:12px; color:#111827; display:inline-flex; align-items:center; gap:6px; cursor:pointer; }
    .chat-stats{ font-size:12px; color:#6B7280; }
    .chat-bar{ border-top:1px solid var(--divider); background:#fff; padding:10px; display:flex; gap:8px; }
    .chat-input{ flex:1; border:1px solid #D1D5DB; border-radius:12px; padding:10px 12px; font-size:13px; }
    .send-btn{ width:36px; height:36px; border-radius:10px; background:#111827; color:#fff; display:flex; align-items:center; justify-content:center; }

    /* ë©”ëª¨ */
    .memo-scroll{ flex:1; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:18px; }
    .memo-sect-head{ font-weight:800; font-size:12px; color:#111827; padding:2px 0; }
    .bmc-grid{ display:grid; grid-template-columns:1fr; gap:10px; }
    .bmc-card{ background:#fff; border:1px solid #E5E7EB; border-radius:10px; padding:12px; }
    .bmc-title{ font-weight:800; font-size:12px; color:#111827; margin-bottom:8px; }
    .bmc-ro{ font-size:13px; line-height:1.65; color:#111827; background:#FFFFFF; border:none; outline:none; border-radius:8px; padding:8px 10px; white-space:pre-wrap; word-break:break-word; }
    .bmc-empty{ color:#9CA3AF; }
    .memo-grid{ display:grid; grid-template-columns:1fr; gap:10px; }
    .memo-card{ background:#fff; border:1px solid #E5E7EB; border-radius:10px; padding:12px; position:relative; }
    .memo-input{ width:100%; min-height:66px; font-size:13px; line-height:1.65; color:#111827; background:#FFFFFF; border:none; outline:none; border-radius:8px; padding:8px 10px; resize:none; overflow:hidden; }
    .memo-del{ position:absolute; top:8px; right:8px; height:24px; padding:0 8px; border:1px solid #E5E7EB; border-radius:6px; background:#fff; font-size:12px; color:#6B7280; cursor:pointer; }
    .memo-bar{ border-top:1px solid var(--divider); padding:10px; background:#fff; display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .memo-info{ font-size:12px; color:#6B7280; }
    .memo-add{ height:30px; padding:0 12px; border:1px solid #111827; background:#111827; color:#fff; border-radius:8px; font-size:12px; font-weight:700; cursor:pointer; }
  </style>
</head>

<body class="font-sans text-white bg-[var(--sb-main-top)] min-h-screen flex flex-col md:flex-row">

  <!-- LEFT SIDEBAR (ê¸°ì¡´ ìœ ì§€) -->
  <aside id="sidebar" class="sidebar hidden md:flex flex-col shrink-0 select-none" data-collapsed="false">
    <div class="brand-area border-b border-white/10 px-[16px] py-[20px]">
      <div class="brand-wrapper">
        <div id="brandToggleArea" class="brand-left">
          <div class="logo-wrapper"><img src="home_assets/logo.png" alt="FOR:WORD" loading="lazy"/></div>
          <div class="expand-icon-wrapper">
            <svg class="w-[16px] h-[16px] text-white/80" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="m9 6 6 6-6 6"/></svg>
          </div>
          <div class="flex flex-col"><div class="brand-text">FOR:WORD</div></div>
        </div>
        <div class="brand-right">
          <div id="collapseToggle" class="collapse-btn" aria-label="Collapse sidebar">
            <svg class="collapse-icon w-[16px] h-[16px] text-white/80" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
          </div>
        </div>
      </div>
    </div>

    <nav class="sidebar-nav-container text-sm">
      <a href="home.html" class="sidebar-nav-btn mb-[4px] hover:bg-white/10">
        <img src="home_assets/Main_icon.svg" alt="Main" class="w-[20px] h-[20px] object-contain" loading="lazy"/>
        <span class="nav-label">Main</span>
      </a>

      <a href="editor.html" class="sidebar-nav-btn mb-[4px] bg-white/10 hover:bg-white/15">
        <img src="home_assets/Editor_icon.svg" alt="Editor View" class="w-[20px] h-[20px] object-contain" loading="lazy"/>
        <span class="nav-label">Editor View</span>
      </a>

      <a href="projects.html" class="sidebar-nav-btn mb-[4px] hover:bg-white/10">
        <img src="home_assets/Project_icon.svg" alt="Projects" class="w-[20px] h-[20px] object-contain opacity-70" loading="lazy"/>
        <span class="nav-label">Projects</span>
      </a>

      <a href="graph.html" class="sidebar-nav-btn mb-[16px] hover:bg-white/10">
        <img src="home_assets/Graph_icon.svg" alt="Knowledge Graph" class="w-[20px] h-[20px] object-contain opacity-70" loading="lazy"/>
        <span class="nav-label">Knowledge Graph</span>
      </a>

      <div class="sidebar-divider"></div>

      <a href="social.html" class="sidebar-nav-btn mb-[4px] hover:bg-white/10">
        <img src="home_assets/Social_icon.svg" alt="Social" class="w-[20px] h-[20px] object-contain" loading="lazy"/>
        <span class="nav-label">Social</span>
      </a>
    </nav>

    <div class="border-t border-white/10 text-xs text-white/60">
      <div class="p-4">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-md bg-white/10 border border-white/20 flex items-center justify-center overflow-hidden">
            <img src="home_assets/Profile_icon.svg" alt="Profile" loading="lazy"/>
          </div>
          <div class="leading-tight">
            <span class="text-white/90 text-[13px] font-medium">hs r</span><br/>
            <span class="text-white/50 text-[11px]">Workspace</span>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- MOBILE NAV -->
  <nav class="md:hidden fixed bottom-0 left-0 right-0 z-50 flex justify-around items-center border-t border-white/10 backdrop-blur-md mobile-nav-bg" style="height:var(--mobile-nav-h);">
    <a href="home.html" class="flex flex-col items-center gap-1 text-[11px] text-white/70">
      <img src="home_assets/Main_icon.svg" alt="Main" class="w-[24px] h-[24px] object-contain" loading="lazy"/>
      <span>Main</span>
    </a>
    <a href="editor.html" class="flex flex-col items-center gap-1 text-[11px] text-white/70">
      <img src="home_assets/Editor_icon.svg" alt="Editor" class="w-[24px] h-[24px] object-contain" loading="lazy"/>
      <span>Editor</span>
    </a>
    <a href="projects.html" class="flex flex-col items-center gap-1 text-[11px] text-white/70">
      <img src="home_assets/Project_icon.svg" alt="Projects" class="w-[24px] h-[24px] object-contain" loading="lazy"/>
      <span>Projects</span>
    </a>
    <a href="graph.html" class="flex flex-col items-center gap-1 text-[11px] text-white/70">
      <img src="home_assets/Graph_icon.svg" alt="Graph" class="w/[24px] h-[24px] object-contain opacity-70" loading="lazy"/>
      <span>Graph</span>
    </a>
    <a href="social.html" class="flex flex-col items-center gap-1 text-[11px] text-white/70">
      <img src="home_assets/Social_icon.svg" alt="Social" class="w/[24px] h/[24px] object-contain" loading="lazy"/>
      <span>Social</span>
    </a>
  </nav>

  <!-- ì¢Œì¸¡: (ëª¨ë“  í”„ë¡œì íŠ¸) ëª©ì°¨ -->
  <aside id="noteCol" class="hidden md:flex flex-col shrink-0">
    <div class="note-head"><span>ëª©ì°¨ â€” All Projects</span></div>
    <div class="note-scroll"><div id="tocRoot" class="toc-tree"></div></div>
    <div class="note-footer">
      <button id="linkBtn" class="w-full h-[38px] rounded-[10px] bg-[#0B0B0E] text-white text-[13px] flex items-center justify-center">ë…¸íŠ¸ ì—°ê²°í•˜ê¸°</button>
    </div>
  </aside>

  <!-- ì¤‘ì•™ -->
  <main class="center-wrap">
    <div class="doc-topbar">
      <input id="docTitle" class="doc-title" placeholder="write title" />
      <div class="doc-actions">
        <span>ìŠ¤í”Œë¦¿ ë·° <span class="chip">ON</span></span>
        <button id="manualSave" class="underline">ì €ì¥</button>
      </div>
    </div>

    <div class="toolbar-wrap">
      <div class="tag-row" id="tagRow">
        <button id="addTagBtn" class="tag-add">+ íƒœê·¸ ì¶”ê°€</button>
      </div>
      <div class="toolbar-row">
        <button class="tbtn" data-cmd="bold">B</button>
        <button class="tbtn" data-cmd="italic"><i>I</i></button>
        <button class="tbtn" data-cmd="underline"><u>U</u></button>
        <div class="tsep"></div>
        <button class="tbtn" data-cmd="justifyLeft">âŸ¸</button>
        <button class="tbtn" data-cmd="justifyCenter">â†”</button>
        <button class="tbtn" data-cmd="justifyRight">âŸ¹</button>
        <div class="tsep"></div>
        <button class="tbtn" id="codeBtn">&lt;&gt;</button>
        <button class="tbtn" id="linkBtnEditor">ğŸ”—</button>
        <button class="tbtn" id="imgBtn">ğŸ–¼ï¸</button>
        <input id="imgFile" type="file" accept="image/*" multiple style="display:none"/>
      </div>
    </div>

    <div id="editorArea" class="editor-area">
      <div id="pageRoot" class="page-root"></div>
    </div>

    <div class="editor-footer" style="border-top:1px solid var(--divider); height:44px; display:flex; align-items:center; justify-content:space-between; padding:0 12px; background:#fff; position:sticky; bottom:0; z-index:2;">
      <div class="flex items-center gap-2">
        <button class="icon-btn" title="ì¦ê²¨ì°¾ê¸°">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.5"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
        </button>
        <button class="icon-btn" title="ì²¨ë¶€" id="attachBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.5"><path d="M21.44 11.05l-9.19 9.19a5 5 0 01-7.07-7.07l9.19-9.19a3 3 0 014.24 4.24l-9.2 9.19a1 1 0 01-1.41-1.41l8.49-8.49"/></svg>
        </button>
      </div>
      <button class="icon-btn" title="ë³´ë‚´ê¸°">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.5"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
      </button>
    </div>
  </main>

  <!-- ìš°ì¸¡ -->
  <aside class="right-col">
    <div class="tabs">
      <button id="tab-chat" class="tab" aria-selected="true" aria-controls="panel-chat">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.5"><path d="M21 15a4 4 0 01-4 4H7l-4 4V7a4 4 0 014-4h10a4 4 0 014 4z"/></svg>
        <span>ì±—ë´‡</span>
      </button>
      <button id="tab-memo" class="tab" aria-selected="false" aria-controls="panel-memo">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.5"><path d="M9 12h6M9 16h6M8 4h8a2 2 0 012 2v12l-4 4H8a2 2 0 01-2-2V6a2 2 0 012-2z"/></svg>
        <span>ë©”ëª¨</span>
      </button>
      <button id="tab-reco" class="tab" aria-selected="false" aria-controls="panel-reco">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="1.5"><path d="M12 2l3 7 7 .5-5 5 1.5 7L12 18 5.5 21 7 14 2 9.5 9 9z"/></svg>
        <span>ì¶”ì²œ</span>
      </button>
    </div>

    <!-- ì±—ë´‡ -->
    <section id="panel-chat" class="panel" data-active="true" role="tabpanel">
      <div class="chat-log" id="chatLog"></div>
      <div class="chat-ctl">
        <div class="flex gap-6 items-center">
          <button id="chatLoadOlder" class="small-btn">ì´ì „ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="chatExport" class="small-btn">ë‚´ë³´ë‚´ê¸°(JSON)</button>
          <button id="chatClear" class="small-btn">ë¹„ìš°ê¸°</button>
        </div>
        <div class="chat-stats" id="chatStats">0 / 0</div>
      </div>
      <div class="chat-bar">
        <input id="chatInput" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."/>
        <button id="chatSend" class="send-btn" title="ì „ì†¡">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.5"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
        </button>
      </div>
    </section>

    <!-- ë©”ëª¨ -->
    <section id="panel-memo" class="panel" role="tabpanel">
      <div id="memoScroll" class="memo-scroll">
        <div>
          <div class="memo-sect-head">BMC ìš”ì•½ (ì½ê¸° ì „ìš©)</div>
          <div id="bmcGrid" class="bmc-grid"></div>
        </div>
        <div>
          <div class="memo-sect-head">ë‚´ ë©”ëª¨</div>
          <div id="userMemoList" class="memo-grid"></div>
        </div>
      </div>

      <div class="memo-bar">
        <div class="memo-info">BMCëŠ” ì½ê¸° ì „ìš© Â· ë‚´ ë©”ëª¨ëŠ” ìë™ ì €ì¥</div>
        <button id="memoAddBtn" class="memo-add">+ ë©”ëª¨ ì¶”ê°€</button>
      </div>
    </section>

    <!-- ì¶”ì²œ -->
    <section id="panel-reco" class="panel" role="tabpanel">
      <div class="bmc-card">
        <div class="bmc-title">ì¶”ì²œ ë…¸íŠ¸</div>
        <div>ì‘ì„± ì¤‘â€¦</div>
      </div>
    </section>
  </aside>

  <script>
    /* ===== Polyfill & helpers ===== */
    (function(){ if (typeof window.CSS === "undefined") window.CSS = {};
      if (!window.CSS.escape){ window.CSS.escape = function(v){ if (arguments.length===0) throw new TypeError('CSS.escape needs arg'); var s=String(v), r='', i=-1, l=s.length, c, f=s.charCodeAt(0);
        while(++i<l){ c=s.charCodeAt(i);
          if(c===0){ r+="\uFFFD";continue;}
          if((c>=1&&c<=31)||c===127||(i===0&&c>=48&&c<=57)||(i===1&&c>=48&&c<=57&&f===45)){ r+="\\"+c.toString(16)+" ";continue;}
          if(i===0&&c===45&&l===1){ r+="\\"+s.charAt(i);continue;}
          if(c>=128||c===45||c===95||(c>=48&&c<=57)||(c>=65&&c<=90)||(c>=97&&c<=122)){ r+=s.charAt(i);continue;}
          r+="\\"+s.charAt(i);
        } return r; }; }
    })();
    const rIC = window.requestIdleCallback || ((cb)=>setTimeout(cb,1));

    /* ===== LocalStorage keys & state ===== */
    const LIST_KEY='fw_projects', DRAFT_KEY='fw_project_draft_v2', LAST_ID_KEY='fw_last_project_id', LAST_NODE_GLOBAL='fw_last_node_global';
    function MEMO_KEY(pid){ return `fw_user_memos_${pid}`; }
    function docsKey(pid){ return `fw_docs_${pid}`; }
    function lastNodeKey(pid){ return `fw_last_node_${pid}`; }
    function tagKeyFor(pid, pathSub){ return `fw_editor_tags_${pid}::${pathSub}`; }
    function tocStateKey(pid){ return `fw_toc_state_${pid}`; }

    let CURRENT_PROJECT=null, CURRENT_PID=null, CURRENT_NODE_PATH=null;
    let SUSPEND_SAVE=0;
    const PAGE={ enabled:true, pending:false };

    /* ===== Utils ===== */
    function safeParse(json, fb){ try{ const v=JSON.parse(json); return (v==null)?fb:v; }catch(_){ return fb; } }
    function htmlToText(html){ const tmp=document.createElement('div'); tmp.innerHTML=html||''; return (tmp.textContent||'').trim(); }
    function escapeHTML(t){ return String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function textToHTML(t){ return escapeHTML(t||'').replace(/\n/g,'<br/>'); }
    function toastOnce(msg){ if(!window.toast) return alert(msg); window.toast(msg); }
    function getProjectList(){ return safeParse(localStorage.getItem(LIST_KEY), []); }
    function getDraft(){ return safeParse(localStorage.getItem(DRAFT_KEY), null); }
    function getProjectById(pid){ const list=getProjectList(); return list.find(p=>p?.id===pid) || (getDraft()?.id===pid ? getDraft():null); }
    function splitFullPath(full){ const i=full.indexOf('::'); if(i<0) return [CURRENT_PID, full]; return [full.slice(0,i), full.slice(i+2)]; }

    /* ===== Sidebar ===== */
    function initSidebar(){
      const sidebar=document.getElementById('sidebar');
      document.getElementById('collapseToggle')?.addEventListener('click',()=> sidebar.setAttribute('data-collapsed','true'));
      document.getElementById('brandToggleArea')?.addEventListener('click',()=>{ if(sidebar.getAttribute('data-collapsed')==='true') sidebar.setAttribute('data-collapsed','false'); });
    }

    /* ===== TOC ===== */
    const BMC_LABELS=[['cs','ê³ ê° ì„¸ë¶„í™”'],['cr','ê³ ê° ê´€ê³„'],['ch','ì±„ë„'],['rs','ìˆ˜ìµ ëª¨ë¸'],['vp','ê°€ì¹˜ ì œì•ˆ'],['ka','í•µì‹¬ í™œë™'],['kr','í•µì‹¬ ìì›'],['kp','í•µì‹¬ íŒŒíŠ¸ë„ˆ'],['cst','ë¹„ìš© êµ¬ì¡°']];
    function buildTocNodesForProject(p){
      const pid=p.id, title=(p?.title||'ë¬´ì œ í”„ë¡œì íŠ¸').trim(), psst=p?.psst||{};
      const trim=(s)=> (String(s||'').replace(/\s+/g,' ').trim()||'â€”').slice(0,50);
      const root={pid, path:`${pid}::project`, type:'project', title:`${title}`, children:[]};
      const grp={pid, path:`${pid}::psst`, type:'psstGroup', title:'PSST', children:[
        {pid, path:`${pid}::psst/p`, type:'psstP', title:`P: ${trim(psst.p)}`, children:[]},
        {pid, path:`${pid}::psst/s1`,type:'psstS', title:`S: ${trim(psst.s1 ?? psst.s)}`, children:[]},
        {pid, path:`${pid}::psst/s2`,type:'psstS', title:`S: ${trim(psst.s2)}`, children:[]},
        {pid, path:`${pid}::psst/t`, type:'psstT', title:`T: ${trim(psst.t)}`, children:[]},
      ]};
      root.children.push(grp);
      root.children.push({pid, path:`${pid}::background`, type:'background', title:`ë°°ê²½`, children:[]});
      return [root];
    }
    function buildAllTocNodes(){ const nodes=[]; const list=getProjectList(); list.forEach(p=>nodes.push(...buildTocNodesForProject(p))); const d=getDraft(); if(d && !list.find(x=>x.id===d.id)) nodes.push(...buildTocNodesForProject(d)); return nodes; }
    function renderTocTree(nodes){
      const root=document.getElementById('tocRoot'); if(!root) return; root.innerHTML='';
      function badgeText(t){ const m={project:'Project', psstGroup:'PSST', background:'BG', psstP:'P', psstS:'S', psstT:'T'}; return m[t]||t; }
      function buildItem(node){
        const hasChild=!!(node.children&&node.children.length);
        const state=safeParse(localStorage.getItem(tocStateKey(node.pid)),{});
        const expanded=state[node.path]!==false;

        const box=document.createElement('div');
        box.className='node'; box.dataset.path=node.path; box.dataset.type=node.type; box.dataset.pid=node.pid;
        if(CURRENT_NODE_PATH===node.path) box.classList.add('is-active');

        const caret=document.createElement('span'); caret.className='caret'; caret.textContent=hasChild?(expanded?'â–¾':'â–¸'):'Â·';
        const badge=document.createElement('span'); badge.className='badge'; badge.textContent=badgeText(node.type);
        const title=document.createElement('span'); title.className='title'; title.textContent=node.title||'(ì œëª©ì—†ìŒ)';
        box.appendChild(caret); box.appendChild(badge); box.appendChild(title);

        const wrap=document.createElement('div'); wrap.className='toc-item'+(expanded?'':' is-collapsed');
        const li=document.createElement('div'); li.className='toc-li'; li.appendChild(box);
        if(hasChild){
          const cwrap=document.createElement('div'); cwrap.className='toc-children';
          const ul=document.createElement('div'); ul.className='toc-ul';
          node.children.forEach(ch=>ul.appendChild(buildItem(ch)));
          cwrap.appendChild(ul); li.appendChild(cwrap);
        }
        wrap.appendChild(li);

        box.addEventListener('click',(ev)=>{
          const onCaret=(ev.offsetX<=22);
          if(hasChild && onCaret){
            const collapsed=li.classList.toggle('is-collapsed');
            caret.textContent=collapsed?'â–¸':'â–¾';
            const s=safeParse(localStorage.getItem(tocStateKey(node.pid)),{})||{};
            s[node.path]=!collapsed; localStorage.setItem(tocStateKey(node.pid), JSON.stringify(s));
          }else{
            openNodeDocument(node.path,node.title,node.pid);
            document.querySelectorAll('.node.is-active').forEach(n=>n.classList.remove('is-active'));
            box.classList.add('is-active');
          }
        });
        return wrap;
      }
      nodes.forEach(n=>root.appendChild(buildItem(n)));
    }
    function rerenderToc(){
      renderTocTree(buildAllTocNodes());
      const active=document.querySelector(`.node[data-path="${CSS.escape(CURRENT_NODE_PATH||'')}"]`);
      if(active){ document.querySelectorAll('.node.is-active').forEach(n=>n.classList.remove('is-active')); active.classList.add('is-active'); }
    }

    /* ===== Docs save/load ===== */
    function saveDocsMap(pid,map){ localStorage.setItem(docsKey(pid), JSON.stringify(map||{})); }
    function loadDocsMap(pid){ return safeParse(localStorage.getItem(docsKey(pid)),{}); }
    function persistProject(){
      try{
        if(!CURRENT_PID||!CURRENT_PROJECT) return;
        const d=getDraft(); if(d && d.id===CURRENT_PID){ localStorage.setItem(DRAFT_KEY, JSON.stringify({...d,...CURRENT_PROJECT, savedAt:new Date().toISOString()})); }
        const list=getProjectList(); const idx=list.findIndex(x=>x&&x.id===CURRENT_PID);
        if(idx>=0){ list[idx]={...list[idx],...CURRENT_PROJECT, savedAt:new Date().toISOString()}; localStorage.setItem(LIST_KEY, JSON.stringify(list)); }
        localStorage.setItem(LAST_ID_KEY, CURRENT_PID);
      }catch(e){ console.error(e); }
    }

    /* ===== Editor refs ===== */
    const editor={ pageRoot:null, title:null, saveBtn:null, tagRow:null, addTagBtn:null };

    function defaultDocHtml(t){ const h=(s)=> (s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); return `<h2>${h(t||'')}</h2>\n<p></p>`; }
    function psstInitialHtmlFor(sub, project){ const key=sub.split('/')[1]; const label={p:'Problem', s1:'Solution', s2:'Strategy', t:'Timeline'}[key]||'PSST'; const val=(project?.psst?.[key]||'').trim(); return `<h2>${label}</h2>\n<p>${textToHTML(val)}</p>`; }

    function createPageOuter(html=''){
      const outer=document.createElement('div'); outer.className='page-outer';
      const sec=document.createElement('section'); sec.className='page'; sec.setAttribute('contenteditable','true');
      if(html) sec.innerHTML=html;
      outer.appendChild(sec);
      return outer;
    }

    function ensureAtLeastOnePage(){
      const root=editor.pageRoot; if(!root) return;
      if(!root.querySelector('.page')){ root.appendChild(createPageOuter('')); }
    }

    function openNodeDocument(fullPath, displayTitle, pidFromNode){
      const [pid, sub]=splitFullPath(fullPath);
      const targetPid=pidFromNode||pid;
      const proj=getProjectById(targetPid);
      if(!proj){ toastOnce('í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      CURRENT_PROJECT=proj; CURRENT_PID=targetPid;

      CURRENT_NODE_PATH=`${CURRENT_PID}::${sub}`;
      localStorage.setItem(LAST_ID_KEY, CURRENT_PID);
      localStorage.setItem(LAST_NODE_GLOBAL, CURRENT_NODE_PATH);
      localStorage.setItem(lastNodeKey(CURRENT_PID), CURRENT_NODE_PATH);

      const map=loadDocsMap(CURRENT_PID);
      if(!map[sub]){
        const isPS=sub.startsWith('psst/');
        const content=isPS? psstInitialHtmlFor(sub, CURRENT_PROJECT) : defaultDocHtml(displayTitle||sub);
        const html=`<div class="page-outer"><section class="page" contenteditable="true">${content}</section></div>`;
        map[sub]={ title:displayTitle||sub, html, type: sub.split('/')[0], updatedAt:new Date().toISOString() };
        saveDocsMap(CURRENT_PID, map);
        toastOnce('ìƒˆ ë¬¸ì„œë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤');
      }

      const doc=map[sub];
      editor.title.value=doc.title||'';
      // ë³´ì •: ì´ì „ ë¬¸ì„œê°€ .page-outer ì—†ì´ ì €ì¥ëœ ê²½ìš° ë˜í•‘
      const needWrap = !/<div[^>]+class=["'][^"']*page-outer[^"']*["']/.test(doc.html||'');
      editor.pageRoot.innerHTML = needWrap ? `<div class="page-outer"><section class="page" contenteditable="true">${doc.html||''}</section></div>` : (doc.html||'');

      ensureAtLeastOnePage();
      updatePageDividers();
      fitPagesToWidth();

      renderTagsFor(CURRENT_PID, sub);
      renderBmcCards();
      renderUserMemos();
      rerenderToc();
      if(PAGE.enabled) reflowPagesDeferred();
    }

    function saveCurrentDoc(){
      if(SUSPEND_SAVE>0) return;
      if(!CURRENT_NODE_PATH||!CURRENT_PID) return;
      const [,sub]=splitFullPath(CURRENT_NODE_PATH);
      const map=loadDocsMap(CURRENT_PID);
      const doc=map[sub]||{ title:'', html:'', type: sub.split('/')[0] };
      doc.title=editor.title.value||'';
      doc.html=editor.pageRoot.innerHTML||'';
      doc.updatedAt=new Date().toISOString();
      map[sub]=doc; saveDocsMap(CURRENT_PID,map);

      if(sub.startsWith('psst/')){
        const k=sub.split('/')[1];
        const first=editor.pageRoot.querySelector('.page');
        const text=htmlToText(first? first.innerHTML:doc.html);
        if(!CURRENT_PROJECT.psst) CURRENT_PROJECT.psst={};
        CURRENT_PROJECT.psst[k]=text; persistProject(); rerenderToc();
      }

      if(editor.saveBtn){
        const old=editor.saveBtn.textContent; editor.saveBtn.textContent='ì €ì¥ë¨';
        setTimeout(()=> editor.saveBtn.textContent=old||'ì €ì¥', 700);
      }
    }
    const autosave=(()=>{ let t=null; return ()=>{ if(SUSPEND_SAVE>0) return; clearTimeout(t); t=setTimeout(saveCurrentDoc, 300); }; })();

    /* ===== íƒœê·¸ ===== */
    function renderTagsFor(pid, sub){
      const row=editor.tagRow, add=editor.addTagBtn;
      Array.from(row.querySelectorAll('.tag-pill')).forEach(n=>n.remove());
      const TAGS=safeParse(localStorage.getItem(tagKeyFor(pid, sub)),[]);
      TAGS.forEach((t,i)=>{
        const b=document.createElement('button'); b.className='tag-pill'; b.textContent=t;
        b.addEventListener('click',()=> b.classList.toggle('active'));
        b.addEventListener('dblclick',()=>{ const a=safeParse(localStorage.getItem(tagKeyFor(pid, sub)),[]); a.splice(i,1); localStorage.setItem(tagKeyFor(pid, sub), JSON.stringify(a)); renderTagsFor(pid, sub); });
        row.insertBefore(b, add);
      });
    }

    /* ===== Right tabs/chat/memo (ì›í˜• ìœ ì§€) ===== */
    function initTabs(){
      const map=[['tab-chat','panel-chat'],['tab-memo','panel-memo'],['tab-reco','panel-reco']];
      function act(id){ map.forEach(([b,p])=>{ const btn=document.getElementById(b), pan=document.getElementById(p), on=(b===id); btn&&btn.setAttribute('aria-selected', on?'true':'false'); pan&&pan.setAttribute('data-active', on?'true':'false'); }); }
      map.forEach(([b])=> document.getElementById(b)?.addEventListener('click',()=>act(b)));
      act('tab-chat');
    }
    function loadUserMemos(){ return safeParse(localStorage.getItem(MEMO_KEY(CURRENT_PID)),[]); }
    function saveUserMemos(list){ localStorage.setItem(MEMO_KEY(CURRENT_PID), JSON.stringify(list||[])); }
    function autoGrow(ta){ if(!ta) return; const minPx=parseInt(getComputedStyle(ta).minHeight,10)||66; ta.style.height='auto'; ta.style.height=Math.max(ta.scrollHeight, minPx)+'px'; }
    function renderBmcCards(){
      const wrap=document.getElementById('bmcGrid'); if(!wrap) return; wrap.innerHTML='';
      const bmc=CURRENT_PROJECT?.bmc||{};
      BMC_LABELS.forEach(([k,label])=>{
        const card=document.createElement('div'); card.className='bmc-card';
        const title=document.createElement('div'); title.className='bmc-title'; title.textContent=label;
        const ro=document.createElement('div'); ro.className='bmc-ro';
        const val=(bmc?.[k]||'').trim(); ro.innerHTML= val ? textToHTML(val) : '<span class="bmc-empty">â€”</span>';
        card.appendChild(title); card.appendChild(ro); wrap.appendChild(card);
      });
    }
    function renderUserMemos(focusLast=false){
      const listEl=document.getElementById('userMemoList'); if(!listEl) return; listEl.innerHTML=''; const memos=loadUserMemos();
      memos.forEach((m,idx)=>{
        const card=document.createElement('div'); card.className='memo-card';
        const del=document.createElement('button'); del.className='memo-del'; del.textContent='ì‚­ì œ';
        del.addEventListener('click',()=>{ const cur=loadUserMemos(); cur.splice(idx,1); saveUserMemos(cur); renderUserMemos(); });
        const ta=document.createElement('textarea'); ta.className='memo-input'; ta.value=m.text||'';
        ta.addEventListener('input',()=>{ const cur=loadUserMemos(); cur[idx]={...cur[idx], text:ta.value, updatedAt:Date.now()}; saveUserMemos(cur); autoGrow(ta); });
        requestAnimationFrame(()=> autoGrow(ta));
        card.appendChild(del); card.appendChild(ta); listEl.appendChild(card);
        if(focusLast && idx===memos.length-1){ setTimeout(()=>{ ta.focus(); ta.setSelectionRange(ta.value.length, ta.value.length); },0); }
      });
    }
    function addUserMemo(){ const memos=loadUserMemos(); memos.push({id:Date.now(), text:'', updatedAt:Date.now()}); saveUserMemos(memos); renderUserMemos(true); }

    function initChat(){
      const CHAT_KEY='fw_editor_chat_log', CHAT_MAX=1000, CHAT_RENDER_WINDOW=120, TRIM_AT_LOAD=2000;
      const log=document.getElementById('chatLog'), input=document.getElementById('chatInput'), send=document.getElementById('chatSend');
      const btnOlder=document.getElementById('chatLoadOlder'), btnExport=document.getElementById('chatExport'), btnClear=document.getElementById('chatClear'), stats=document.getElementById('chatStats');
      let all=[], startIdx=0;
      function loadChat(){ let arr=[]; try{ arr=JSON.parse(localStorage.getItem(CHAT_KEY)||'[]'); }catch(e){ arr=[]; } if(arr.length>TRIM_AT_LOAD){ arr=arr.slice(-CHAT_MAX); localStorage.setItem(CHAT_KEY, JSON.stringify(arr)); } return arr; }
      function saveChat(list){ if(list.length>CHAT_MAX) list=list.slice(-CHAT_MAX); localStorage.setItem(CHAT_KEY, JSON.stringify(list)); return list; }
      function bubble(m){ const d=document.createElement('div'); d.className='bubble '+(m.role==='me'?'me':'bot'); d.textContent=m.text; return d; }
      function updateStats(){ const end=Math.min(all.length, startIdx+CHAT_RENDER_WINDOW); stats.textContent=`${all.length?(startIdx+1):0} - ${end} / ${all.length}`; }
      function render(reset=false){ log.innerHTML=''; const frag=document.createDocumentFragment(); const end=Math.min(all.length, startIdx+CHAT_RENDER_WINDOW); for(let i=startIdx;i<end;i++) frag.appendChild(bubble(all[i])); log.appendChild(frag); updateStats(); if(reset){ log.scrollTop=log.scrollHeight+9999; } }
      function tail(){ startIdx=Math.max(0, all.length-CHAT_RENDER_WINDOW); render(true); }
      function push(role, text){ all.push({role,text,ts:Date.now()}); all=saveChat(all); tail(); }

      all=loadChat(); if(all.length===0){ all=[{role:'bot', text:'ì•ˆë…•í•˜ì„¸ìš”! ë…¸íŠ¸ ì‘ì„±ì„ ë„ì™€ë“œë¦¬ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.', ts:Date.now()}]; all=saveChat(all); } tail();
      function sendNow(){ const v=input.value.trim(); if(!v) return; push('me', v); input.value=''; setTimeout(()=> push('bot','ê¸°ë¡í–ˆì–´ìš”.'),120); }
      send&&(send.onclick=sendNow); input&&input.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendNow(); } });
      btnOlder&&btnOlder.addEventListener('click',()=>{ if(startIdx===0) return; startIdx=Math.max(0, startIdx-CHAT_RENDER_WINDOW); render(false); });
      btnExport&&btnExport.addEventListener('click',()=>{ const blob=new Blob([JSON.stringify(all,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); const d=new Date(); const fn=`chat-export-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.json`; a.href=url; a.download=fn; a.click(); URL.revokeObjectURL(url); });
      btnClear&&btnClear.addEventListener('click',()=>{ if(!confirm('ì±—ë´‡ ëŒ€í™”ë¥¼ ëª¨ë‘ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ? ë‚´ë³´ë‚´ê¸°ë¡œ ë°±ì—…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) return; all=[{role:'bot', text:'ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', ts:Date.now()}]; localStorage.setItem(CHAT_KEY, JSON.stringify(all)); tail(); });
    }

    /* ===== Toolbar & media insert ===== */
    function caretSafeInsert(node){
      const sel=window.getSelection();
      if(!sel||sel.rangeCount===0){
        const first=editor.pageRoot.querySelector('.page')||editor.pageRoot;
        first.appendChild(node); return;
      }
      const range=sel.getRangeAt(0); range.collapse(false); range.insertNode(node);
      const r2=document.createRange(); r2.setStartAfter(node); r2.setEndAfter(node); sel.removeAllRanges(); sel.addRange(r2);
    }
    function fileToDataURL(file){ return new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(file); }); }
    async function insertImageFiles(fileList){
      const files=Array.from(fileList).filter(f=>/^image\//i.test(f.type)); if(!files.length) return;
      SUSPEND_SAVE++;
      for(const f of files){
        const dataURL=await fileToDataURL(f);
        const img=document.createElement('img'); img.src=dataURL; img.alt=f.name||'image'; img.style.maxWidth='100%'; img.style.height='auto';
        img.onload=()=>{ if(PAGE.enabled) reflowPagesDeferred(); };
        caretSafeInsert(img);
      }
      SUSPEND_SAVE--; autosave(); if(PAGE.enabled) reflowPagesDeferred();
    }
    function initToolbar(){
      const root=editor.pageRoot;
      document.querySelectorAll('.tbtn[data-cmd]').forEach(btn=>{
        btn.addEventListener('click',()=>{ document.execCommand(btn.dataset.cmd,false,null); root&&root.focus(); autosave(); if(PAGE.enabled) reflowPagesDeferred(); });
      });
      document.getElementById('linkBtnEditor')?.addEventListener('click',()=>{ const url=prompt('ë§í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”'); if(!url) return; document.execCommand('createLink',false,url); root.focus(); autosave(); if(PAGE.enabled) reflowPagesDeferred(); });
      const imgFile=document.getElementById('imgFile');
      document.getElementById('imgBtn')?.addEventListener('click',()=> imgFile&&imgFile.click());
      document.getElementById('attachBtn')?.addEventListener('click',()=> imgFile&&imgFile.click());
      imgFile?.addEventListener('change', async(e)=>{ if(!e.target.files||!e.target.files.length) return; await insertImageFiles(e.target.files); e.target.value=''; });
    }

    function initDragAndPaste(){
      const area=document.getElementById('editorArea');
      area.addEventListener('dragover',(e)=>{ if(e.dataTransfer && [...(e.dataTransfer.items||[])].some(it=>it.kind==='file')){ e.preventDefault(); }});
      area.addEventListener('drop', async(e)=>{ if(!e.dataTransfer) return; const files=e.dataTransfer.files; if(files&&files.length){ e.preventDefault(); await insertImageFiles(files); }});

      editor.pageRoot.addEventListener('paste', async(e)=>{
        const cd=e.clipboardData||window.clipboardData; if(!cd) return;
        const types=cd.types?Array.from(cd.types):[];
        const hasHTML=types.includes('text/html');
        const hasImg=cd.items? Array.from(cd.items).some(it=>it.type && it.type.indexOf('image/')===0):false;
        if(hasHTML||hasImg){
          e.preventDefault(); SUSPEND_SAVE++;
          if(hasHTML){
            let html=cd.getData('text/html')||'';
            html=extractBody(html); html=cleanPastedHTML(html); html=removeOfficeImagePlaceholders(html);
            insertHTMLAtCaret(html);
          }
          if(hasImg){ await insertImagesFromClipboardItems(cd.items); }
          SUSPEND_SAVE--; autosave(); if(PAGE.enabled) reflowPagesDeferred();
        }
      }, true);
    }
    function extractBody(html){ const m=/<body[^>]*>([\s\S]*?)<\/body>/i.exec(html); return m?m[1]:html; }
    function cleanPastedHTML(html){
      html=html.replace(/<!--\[if[\s\S]*?<!\[endif\]-->/gi,'');
      html=html.replace(/<(script|style|title|meta|link|xml|iframe|object|embed|noscript)[\s\S]*?>[\s\S]*?<\/\1>/gi,'');
      html=html.replace(/<(v:|o:|w:)[^>]+>/gi,''); html=html.replace(/<\/(v:|o:|w:)[^>]+>/gi,'');
      html=html.replace(/\s(on\w+)=(".*?"|'.*?'|[^\s>]+)/gi,'');
      html=html.replace(/<img([^>]+)src\s*=\s*"(file:[^"]+)"([^>]*)>/gi,'');
      return html;
    }
    function removeOfficeImagePlaceholders(html){
      return html.replace(/<p[^>]*>(\s|&nbsp;)*(ê·¸ë¦¼ì…ë‹ˆë‹¤\.|ì›ë³¸ ê·¸ë¦¼ì˜ ì´ë¦„|ì›ë³¸ ê·¸ë¦¼ì˜ í¬ê¸°|This is a picture\.)[\s\S]*?<\/p>/gi,'');
    }
    async function insertImagesFromClipboardItems(items){
      const imgs=Array.from(items).filter(it=>it.type && it.type.indexOf('image/')===0);
      for(const it of imgs){ const file=it.getAsFile && it.getAsFile(); if(file) await insertImageFiles([file]); }
    }
    function insertHTMLAtCaret(html){
      const sel=window.getSelection(); if(!sel||sel.rangeCount===0){ document.execCommand('insertHTML',false,html); return; }
      const range=sel.getRangeAt(0); range.deleteContents();
      const tmp=document.createElement('div'); tmp.innerHTML=html;
      const frag=document.createDocumentFragment(); while(tmp.firstChild) frag.appendChild(tmp.firstChild);
      range.insertNode(frag); sel.removeAllRanges();
    }

    /* ===== Pagination & page dividers ===== */
    function pageFromOuter(outer){ return outer.querySelector('.page'); }
    function nextPage(page){
      const outer=page.closest('.page-outer'); let n=outer && outer.nextElementSibling;
      while(n && n.classList.contains('page-divider')) n=n.nextElementSibling;
      return n && n.classList.contains('page-outer') ? pageFromOuter(n) : null;
    }
    function ensureNextPage(page){
      const n=nextPage(page);
      if(n) return n;
      const outer=createPageOuter('');
      const curOuter=page.closest('.page-outer');
      curOuter.parentNode.insertBefore(outer, curOuter.nextSibling);
      return pageFromOuter(outer);
    }

    function updatePageDividers(){
      const root=editor.pageRoot; if(!root) return;
      Array.from(root.querySelectorAll('.page-divider')).forEach(n=>n.remove());
      const outers=Array.from(root.querySelectorAll('.page-outer'));
      for(let i=0;i<outers.length-1;i++){
        const div=document.createElement('div');
        div.className='page-divider';
        div.innerHTML='<div class="line"></div><div class="badge">â€” NEW PAGE â€”</div>';
        outers[i].insertAdjacentElement('afterend', div);
      }
      fitPagesToWidth(); // êµ¬ë¶„ì„  í­ë„ ë§ì¶¤
    }

    function reflowPagesDeferred(){
      if(!PAGE.enabled) return;
      if(PAGE.pending) return;
      PAGE.pending=true;
      rIC(()=>{ try{ reflowAllPages(); } finally{ PAGE.pending=false; autosave(); fitPagesToWidth(); } });
    }

    function reflowAllPages(){
      const root=editor.pageRoot; if(!root) return;
      // êµ¬ë¶„ì„  ì œê±° í›„ ê³„ì‚°
      Array.from(root.querySelectorAll('.page-divider')).forEach(n=>n.remove());

      let pages=Array.from(root.querySelectorAll('.page'));
      if(pages.length===0){
        root.appendChild(createPageOuter('')); pages=[root.querySelector('.page')];
      }

      // ë„˜ì¹˜ëŠ” ì½˜í…ì¸  ì•„ë˜ë¡œ ì´ë™
      pages.forEach(p=> shiftOverflowDown(p));
      // ê³µê°„ ë‚¨ìœ¼ë©´ ìœ„ì—ì„œ ëŒì–´ì˜¤ê¸°
      pages.forEach(p=> pullUpIfSpace(p));

      // ë¹ˆ í˜ì´ì§€ ì œê±°
      const outers=Array.from(root.querySelectorAll('.page-outer'));
      for(let i=outers.length-1;i>0;i--){
        const pg=pageFromOuter(outers[i]);
        if(pg && pg.innerHTML.trim()===''){ outers[i].remove(); }
      }

      updatePageDividers();
    }

    function shiftOverflowDown(page){
      const MAX=2000; let guard=0;
      while(page.scrollHeight > page.clientHeight + 1 && guard++<MAX){
        let np=nextPage(page); if(!np) np=ensureNextPage(page);

        let last=page.lastChild; if(!last) break;
        if(last.nodeType===Node.TEXT_NODE){
          const p=document.createElement('p'); p.textContent=last.textContent; page.removeChild(last); page.appendChild(p); last=p;
        }
        if(last.nodeType!==Node.ELEMENT_NODE){ np.insertBefore(last, np.firstChild); continue; }
        if(last.tagName==='IMG'){ np.insertBefore(last, np.firstChild); continue; }
        if(last.offsetHeight > page.clientHeight - 8){
          splitElementToNext(last, page, np); continue;
        }
        np.insertBefore(last, np.firstChild);
      }
    }
    function pullUpIfSpace(page){
      const np=nextPage(page); if(!np) return;
      let safety=0;
      while(np.firstChild && (page.scrollHeight + (np.firstChild.offsetHeight||0)) <= page.clientHeight - 2 && safety++<2000){
        page.appendChild(np.firstChild);
      }
      if(np.innerHTML.trim()===''){
        const outer=np.closest('.page-outer'); if(outer) outer.remove();
      }
    }
    function splitElementToNext(el, page, np){
      if(el.childNodes && el.childNodes.length>1){
        let safety=0;
        while(page.scrollHeight > page.clientHeight + 1 && el.lastChild && safety++<2000){
          const child=el.lastChild;
          if(child.nodeType===Node.TEXT_NODE){
            const p=document.createElement('p'); p.textContent=child.textContent; el.removeChild(child); el.appendChild(p);
            splitElementToNext(p, page, np);
          }else if(child.nodeType===Node.ELEMENT_NODE){
            if(child.tagName==='IMG'){ np.insertBefore(child, np.firstChild); }
            else if(child.offsetHeight > page.clientHeight - 8){ splitElementToNext(child, page, np); }
            else{ np.insertBefore(child, np.firstChild); }
          }else{
            np.insertBefore(child, np.firstChild);
          }
        }
        if(!el.childNodes.length){ el.remove(); }
        return;
      }
      if(el.childNodes.length===1 && el.firstChild.nodeType===Node.TEXT_NODE){ binarySplitTextElement(el, page, np); return; }
      np.insertBefore(el, np.firstChild);
    }
    function binarySplitTextElement(el, page, np){
      const full=el.textContent||''; if(!full.trim()){ np.insertBefore(el, np.firstChild); return; }
      let low=1, high=full.length, fit=0, original=full;
      while(low<=high){
        const mid=(low+high)>>1;
        el.textContent=original.slice(0, mid);
        if(page.scrollHeight <= page.clientHeight){ fit=mid; low=mid+1; } else { high=mid-1; }
      }
      const rest=original.slice(fit);
      if(rest.length){
        const clone=el.cloneNode(false); clone.textContent=rest;
        np.insertBefore(clone, np.firstChild);
      }
    }

    /* ===== Fit to width (ê°€ë¡œ ê½‰ ì°¨ê²Œ ìŠ¤ì¼€ì¼) ===== */
    function fitPagesToWidth(){
      const area=document.getElementById('editorArea'); if(!area) return;
      const avail=Math.max(100, area.clientWidth - 24); // ì¢Œìš° padding 12px
      let scaledW=0;
      const outers=Array.from(editor.pageRoot.querySelectorAll('.page-outer'));
      outers.forEach(outer=>{
        const page=pageFromOuter(outer); if(!page) return;
        const pw=page.offsetWidth, ph=page.offsetHeight;
        const scale=Math.max(0.2, avail / pw);
        page.style.transform=`scale(${scale})`;
        outer.style.height=(ph*scale)+'px';
        scaledW = pw*scale; // ë§ˆì§€ë§‰ ê°’ìœ¼ë¡œ êµ¬ë¶„ì„  í­ ì„¸íŒ…
      });
      Array.from(editor.pageRoot.querySelectorAll('.page-divider')).forEach(div=>{
        div.style.width = scaledW ? (scaledW+'px') : '100%';
        div.style.marginLeft='auto'; div.style.marginRight='auto';
      });
    }

    /* ===== Toast ===== */
    function initToast(){
      const div=document.createElement('div');
      div.style.position='fixed'; div.style.left='50%'; div.style.bottom='24px'; div.style.transform='translateX(-50%)';
      div.style.padding='10px 14px'; div.style.border='1px solid #E5E7EB'; div.style.background='#fff'; div.style.borderRadius='10px';
      div.style.boxShadow='0 8px 24px rgba(0,0,0,.08)'; div.style.fontSize='13px'; div.style.color='#111827';
      div.style.display='none'; div.style.zIndex='9999';
      document.body.appendChild(div);
      window.toast=(msg)=>{ div.textContent=msg; div.style.display='block'; setTimeout(()=> div.style.display='none', 1200); };
    }

    /* ===== Init ===== */
    function initNotePanelAndEditor(){
      const lastNodeGlobal=localStorage.getItem('fw_last_node_global');
      let initialProject=null;
      if(lastNodeGlobal){ const [pid]=splitFullPath(lastNodeGlobal); const p=getProjectById(pid); if(p) initialProject=p; }
      if(!initialProject){
        const list=getProjectList(); const lastPid=localStorage.getItem(LAST_ID_KEY);
        initialProject=(lastPid && getProjectById(lastPid)) || (list && list[0]) || getDraft() || null;
      }
      if(!initialProject){
        const root=document.getElementById('tocRoot');
        if(root) root.innerHTML='<div class="text-[13px] text-gray-500">ë³µì›í•  í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. Projectsì—ì„œ ìƒˆë¡œ ìƒì„±í•´ ì£¼ì„¸ìš”.</div>';
        return;
      }

      CURRENT_PROJECT=initialProject; CURRENT_PID=initialProject.id; localStorage.setItem(LAST_ID_KEY, CURRENT_PID);
      rerenderToc();

      editor.pageRoot=document.getElementById('pageRoot');
      editor.title=document.getElementById('docTitle');
      editor.saveBtn=document.getElementById('manualSave');
      editor.tagRow=document.getElementById('tagRow');
      editor.addTagBtn=document.getElementById('addTagBtn');

      ensureAtLeastOnePage();
      updatePageDividers();
      fitPagesToWidth();

      editor.pageRoot.addEventListener('input', ()=>{ if(PAGE.enabled) reflowPagesDeferred(); });
      editor.title.addEventListener('input', autosave);
      editor.saveBtn?.addEventListener('click', saveCurrentDoc);

      editor.addTagBtn?.addEventListener('click', ()=>{
        if(!CURRENT_NODE_PATH){ toastOnce('ë¨¼ì € ì¢Œì¸¡ ëª©ì°¨ì—ì„œ ë¬¸ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
        const [, sub]=splitFullPath(CURRENT_NODE_PATH);
        const t=prompt('íƒœê·¸ ì…ë ¥'); if(!t) return;
        const arr=safeParse(localStorage.getItem(tagKeyFor(CURRENT_PID, sub)),[]); arr.push(t);
        localStorage.setItem(tagKeyFor(CURRENT_PID, sub), JSON.stringify(arr)); renderTagsFor(CURRENT_PID, sub);
      });

      const fallback='psst/p';
      const startPath=lastNodeGlobal || `${CURRENT_PID}::${fallback}`;
      openNodeDocument(startPath, lastNodeGlobal?null:'P');

      renderBmcCards(); renderUserMemos();
      window.addEventListener('resize', ()=> fitPagesToWidth());
    }

    function initSidebarAndPanels(){
      initSidebar(); initToast(); initTabs(); initChat();
      document.getElementById('linkBtn')?.addEventListener('click', ()=>{
        if(!CURRENT_NODE_PATH){ toastOnce('ë¨¼ì € ì¢Œì¸¡ ëª©ì°¨ì—ì„œ ë¬¸ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”'); return; }
        const [pid, sub]=splitFullPath(CURRENT_NODE_PATH);
        const linked={ at:Date.now(), projectId:pid, node:sub, title:document.getElementById('docTitle').value || sub };
        localStorage.setItem('fw_linked_note', JSON.stringify(linked));
        toastOnce('ë…¸íŠ¸ë¥¼ ì—°ê²°í–ˆìŠµë‹ˆë‹¤.');
      });
      document.getElementById('memoAddBtn')?.addEventListener('click', ()=>{ const memos=loadUserMemos(); memos.push({id:Date.now(), text:'', updatedAt:Date.now()}); saveUserMemos(memos); renderUserMemos(true); });
    }

    window.addEventListener('load', ()=>{
      initSidebarAndPanels();
      initNotePanelAndEditor();
      initToolbar();
      initDragAndPaste();
    });
  </script>
</body>
</html>
