<!doctype html>
<html lang="ko" class="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FOR:WORD â€” Create Project (Step 2)</title>

  <!-- Pretendard -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard@1.3.9/dist/web/static/pretendard.css"/>

  <!-- Tailwind (dev only) -->
  <script>
    window.tailwind = window.tailwind || {};
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { fontFamily: { sans: ['Pretendard','system-ui','sans-serif'] } } }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>

  <style>
    :root{
      /* ===== ë ˆì´ì•„ì›ƒ í† í° ===== */
      --page-max: 1450px;
      --col-gap-x: 50px;      /* ì—´ ê°„ê²© */
      --col-gap-y: 35px;      /* ì¹´ë“œ ì„¸ë¡œ ê°„ê²© */
      --col1-card-w: 260px;   /* 1ì—´: í—¤ë”+ë°°ê²½ */
      --col2-card-w: 400px;   /* 2ì—´: BMC í‘œ */
      --col3-card-w: 500px;   /* 3ì—´: PSST */

      /* ë„¤ë¹„/ë°°ê²½ */
      --sb-nav-top: rgba(30,31,31,0.9);
      --sb-nav-bottom: #848C95;
      --sb-main-top: #2C2C2C;
      --sb-main-bottom: #929292;

      --sidebar-w: 212px;
      --sidebar-w-collapsed: 68px;
      --mobile-nav-h: 64px;

      --status-color:#8A8CD9;
      --scroll-thumb: rgba(55,65,81,0.45);
      --scroll-thumb-hover: rgba(55,65,81,0.65);

      /* ë³¸ë¬¸ íƒ€ì´í¬ */
      --body-pt: 10pt; --body-w: 300;

      /* ë°°ì§€/ì¹© */
      --badge-bg:#F2F3FF; --badge-bd:#E6E7FF; --badge-fg:#1f2345;
    }

    body{ overflow:hidden; font-family:Pretendard, system-ui, sans-serif; letter-spacing:-0.02em; }
    .tap-highlight-clear{ -webkit-tap-highlight-color: rgba(0,0,0,0); }

    /* ===== Sidebar ===== */
    .sidebar{ width:var(--sidebar-w); background: linear-gradient(to bottom, var(--sb-nav-top) 0%, var(--sb-nav-bottom) 100%); transition: width 0.18s ease; }
    .sidebar[data-collapsed="true"]{ width:var(--sidebar-w-collapsed); }
    .brand-text{ font-size:18px; font-weight:600; line-height:1.2; letter-spacing:-0.02em; color:#fff; white-space:nowrap; }
    .sidebar[data-collapsed="true"] .brand-text{ display:none; }
    .brand-wrapper{ display:flex; align-items:center; justify-content:space-between; width:100%; }
    .brand-left{ display:flex; align-items:center; gap:12px; cursor:pointer; width:auto; }
    .sidebar[data-collapsed="true"] .brand-left{ justify-content:center; width:100%; gap:0 !important; }
    .logo-wrapper{ width:32px; height:32px; border-radius:6px; background-color:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .logo-wrapper img{ width:100%; height:100%; object-fit:contain; }
    .sidebar[data-collapsed="true"] .logo-wrapper{ display:none; }
    .expand-icon-wrapper{ width:32px; height:32px; border-radius:6px; background-color:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); display:none; align-items:center; justify-content:center; }
    .sidebar[data-collapsed="true"] .expand-icon-wrapper{ display:flex; }
    .brand-right{ display:flex; align-items:center; justify-content:center; }
    .sidebar[data-collapsed="true"] .brand-right{ display:none; }
    .collapse-btn{ width:28px; height:28px; border-radius:6px; display:flex; align-items:center; justify-content:center; background-color:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); cursor:pointer; }
    .collapse-icon{ transition:transform .18s ease; }
    .sidebar[data-collapsed="true"] .collapse-icon{ transform:rotate(180deg); }

    .sidebar-nav-container{ display:flex; flex-direction:column; flex-grow:1; padding:24px 16px; }
    .sidebar[data-collapsed="true"] .sidebar-nav-container{ padding-left:10px; padding-right:10px; }
    .sidebar-nav-btn{ width:180px; height:48px; display:flex; align-items:center; border-radius:0.5rem; padding:0 12px; gap:10px; text-align:left; color:inherit; text-decoration:none; transition:background-color .12s ease,color .12s ease; }
    .sidebar-nav-btn:hover{ background-color:rgba(255,255,255,0.1); }
    .sidebar[data-collapsed="true"] .sidebar-nav-btn{ width:48px; justify-content:center; gap:0; padding-left:0; padding-right:0; }
    .sidebar[data-collapsed="true"] .sidebar-nav-btn span.nav-label{ display:none; }
    .sidebar-divider{ width:100%; border-top:1px solid rgba(255,255,255,0.15); margin:16px 0; }

    /* ===== Page ===== */
    .main-bg{ background:linear-gradient(to bottom, var(--sb-main-top) 0%, var(--sb-main-bottom) 100%); }
    .mobile-nav-bg{ background:linear-gradient(to bottom, var(--sb-nav-top) 0%, var(--sb-nav-bottom) 100%); }

    .page-inner{ max-width: var(--page-max); width:100%; display:flex; flex-direction:column; }
    .projects-wrapper{ display:flex; flex-direction:row; align-items:flex-start; gap:32px; width:100%; }
    .right-region{ flex:1 1 auto; min-width:0; display:flex; flex-direction:column; }
    .right-header .hero-title{ color:#fff; font-size:32px; font-weight:700; letter-spacing:1px; }

    .board-shell{
      position:relative; display:flex; flex-direction:column;
      background:#FFFFFF; border-radius:8px; border:1px solid rgba(0,0,0,0.08);
      box-shadow:0 24px 60px rgba(0,0,0,0.4);
      height:800px; margin-top:32px; padding:20px 0 20px 20px;
      color:#000; overflow:hidden;
    }

    .board-head-row{ display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; padding-right:20px; gap:10px; }
    .board-head-left{ font-size:16px; font-weight:600; color:#000; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

    .save-btn{
      background:transparent; color:#000; border:none;
      border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .save-btn:disabled{ color:#9CA3AF; cursor:not-allowed; }

    .projects-scroller{
      position:relative; flex:1 1 auto; min-height:0;
      overflow-y:auto; overflow-x:hidden; overscroll-behavior:contain; padding-bottom:8px;
      scrollbar-width:thin; scrollbar-color:var(--scroll-thumb) transparent;
    }
    .projects-scroller::-webkit-scrollbar{ width:6px; }
    .projects-scroller::-webkit-scrollbar-thumb{ background:var(--scroll-thumb); border-radius:9999px; }
    .projects-scroller::-webkit-scrollbar-thumb:hover{ background:var(--scroll-thumb-hover); }

    .projects-row{
      position:relative; display:grid;
      grid-template-columns: var(--col1-card-w) var(--col2-card-w) var(--col3-card-w);
      column-gap: var(--col-gap-x);
      row-gap: 0;
      width:100%; align-items:start; padding-right:20px;
      justify-content:start;
    }

    .projects-col{ display:flex; flex-direction:column; gap: var(--col-gap-y); width:100%; }
    #col1{ grid-column:1; } #col2{ grid-column:2; } #col3{ grid-column:3; }

    /* ===== ê³µí†µ ì¹´ë“œ ===== */
    .proj-card{
      background:#fff; border:1px solid rgba(0,0,0,0.07);
      border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,0.06);
      padding:16px; color:#000; display:flex; flex-direction:column; gap:14px;
      position:relative; min-width:0;
    }
    .proj-toprow{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .proj-title{ font-weight:700; font-size:13px; color:#000; letter-spacing:-0.02em; word-break:break-word; }
    .proj-toprow .proj-texts{ flex:1 1 auto; min-width:0; }

    .proj-iconwrap{
      width:56px; height:56px; border-radius:9999px; background:#2E2F9F; color:#fff;
      display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:500; line-height:1; flex-shrink:0; cursor:pointer; user-select:none;
    }
    .proj-iconwrap .emoji{ font-size:30px; line-height:1; transform: translateY(1px); }

    .proj-status-row{ display:flex; align-items:center; gap:8px; font-size:13px; justify-content:flex-end; }
    .proj-status-dot{ width:8px; height:8px; border-radius:9999px; background:var(--status-color); }
    .proj-status-text{ color:var(--status-color); font-weight:500; }
    .proj-progressbar{ width:100%; height:4px; border-radius:2px; background:#efefef; }
    .proj-progress-inner{ height:100%; border-radius:2px; background:var(--status-color); width:0%; }
    .proj-footer-row{ display:flex; align-items:flex-start; justify-content:space-between; gap:8px; font-size:13px; color:#000; }
    .proj-percent{ font-weight:500; color:#000; white-space:nowrap; }
    .proj-hint{ font-size:11px; color:rgba(0,0,0,0.45); }

    /* ===== ì…ë ¥ ê³µí†µ ===== */
    .para-input{
      width:100%; min-height:72px; line-height:1.65; color:rgba(0,0,0,0.9);
      outline:none; white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere;
      background:transparent; border:none; padding:2px 2px; border-radius:2px;
      font-size:var(--body-pt); font-weight:var(--body-w);
    }
    .para-input:empty:before{ content: attr(data-placeholder); color: rgba(0,0,0,0.35); }

    /* ===== BMC í‘œ ===== */
    .bmc-table{ display:grid; grid-template-columns: 80px 1fr; gap:10px 12px; }
    .bmc-table .k{ font-size:12px; font-weight:800; color:#111827; background:#F9FAFB; border:1px solid rgba(0,0,0,0.06); padding:6px 8px; border-radius:8px; }
    .bmc-table .v{ font-size:12px; color:#111827; background:#FFFFFF; border:none; padding:6px 8px; border-radius:8px; min-height:36px; }

    /* ===== PSST ===== */
    .psst-row{ display:flex; align-items:flex-start; gap:10px; }
    .psst-badge{ flex:0 0 64px; height:28px; border-radius:8px; display:flex; align-items:center; justify-content:center;
      background:var(--badge-bg); border:1px solid var(--badge-bd); color:var(--badge-fg); font-size:12px; font-weight:800; }
    .psst-input{ flex:1 1 auto; min-height:36px; }
    .psst-tip{ font-size:11px; color:rgba(0,0,0,0.45); margin-top:-6px; padding-left:74px; }

    /* ===== ëª¨ë°”ì¼ ===== */
    @media(max-width:767px){
      .projects-wrapper{ flex-direction:column; align-items:stretch; gap:24px; }
      .right-region{ order:-1; width:100%; }
      .board-shell{ height: calc(100vh - var(--mobile-nav-h) - 120px); }
      .projects-row{ grid-template-columns: 1fr; column-gap: 0; }
      #col1,#col2,#col3{ grid-column:1; }
      .projects-col{ gap: calc(var(--col-gap-y) * 0.8); }
    }

    /* ===== í† ìŠ¤íŠ¸ ===== */
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; font-weight:600; box-shadow:0 10px 30px rgba(0,0,0,0.25); z-index:9999; opacity:0; transition:opacity .18s ease, transform .18s ease; }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }
  </style>
</head>

<body class="text-white bg-[var(--sb-main-top)] min-h-screen flex flex-col md:flex-row">
  <!-- LEFT SIDEBAR -->
  <aside id="sidebar" class="sidebar hidden md:flex flex-col shrink-0 select-none" data-collapsed="false">
    <div class="brand-area border-b border-white/10 px-[16px] py-[20px]">
      <div class="brand-wrapper">
        <div id="brandToggleArea" class="brand-left">
          <div class="logo-wrapper"><img src="home_assets/logo.png" alt="FOR:WORD"/></div>
          <div class="expand-icon-wrapper">
            <svg class="w-[16px] h-[16px] text-white/80" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="m9 6 6 6-6 6"/></svg>
          </div>
          <div class="flex flex-col"><div class="brand-text">FOR:WORD</div></div>
        </div>
        <div class="brand-right">
          <div id="collapseToggle" class="collapse-btn tap-highlight-clear" aria-label="Collapse sidebar">
            <svg class="collapse-icon w-[16px] h-[16px] text-white/80" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
          </div>
        </div>
      </div>
    </div>

    <nav class="sidebar-nav-container text-sm">
      <a href="home.html" class="sidebar-nav-btn tap-highlight-clear mb-[4px] hover:bg-white/10">
        <img src="home_assets/Main_icon.svg" alt="Main" class="w-[20px] h-[20px] object-contain"/>
        <span class="nav-label">Main</span>
      </a>
      <a href="editor.html" class="sidebar-nav-btn tap-highlight-clear mb-[4px] hover:bg-white/10">
        <img src="home_assets/Editor_icon.svg" alt="Editor View" class="w-[20px] h-[20px] object-contain opacity-70"/>
        <span class="nav-label">Editor View</span>
      </a>
      <a href="projects.html" class="sidebar-nav-btn tap-highlight-clear mb-[4px] hover:bg-white/10">
        <img src="home_assets/Project_icon.svg" alt="Projects" class="w-[20px] h-[20px] object-contain"/>
        <span class="nav-label">Projects</span>
      </a>
      <a href="graph.html" class="sidebar-nav-btn tap-highlight-clear mb-[16px] hover:bg-white/10">
        <img src="home_assets/Graph_icon.svg" alt="Knowledge Graph" class="w-[20px] h-[20px] object-contain opacity-70"/>
        <span class="nav-label">Knowledge Graph</span>
      </a>

      <div class="sidebar-divider"></div>

      <a href="social.html" class="sidebar-nav-btn tap-highlight-clear mb-[4px] hover:bg-white/10">
        <img src="home_assets/Social_icon.svg" alt="Social" class="w-[20px] h-[20px] object-contain"/>
        <span class="nav-label">Social</span>
      </a>
    </nav>

    <div class="border-t border-white/10 text-xs text-white/60">
      <div class="p-4">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-md bg-white/10 border border-white/20 flex items-center justify-center overflow-hidden">
            <img src="home_assets/Profile_icon.svg" alt="Profile"/>
          </div>
          <div class="leading-tight">
            <span class="text-white/90 text-[13px] font-medium">hs r</span><br/>
            <span class="text-white/50 text-[11px]">Workspace</span>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- MOBILE NAV -->
  <nav class="md:hidden fixed bottom-0 left-0 right-0 z-50 flex justify-around items-center border-t border-white/10 backdrop-blur-md mobile-nav-bg"
       style="height:var(--mobile-nav-h);">
    <a href="home.html" class="flex flex-col items-center gap-1 text-[11px] text-white/70">
      <img src="home_assets/Main_icon.svg" alt="Main" class="w-[24px] h-[24px] object-contain"/>
      <span>Main</span>
    </a>
    <a href="editor.html" class="flex flex-col items-center gap-1 text-[11px] text-white/70">
      <img src="home_assets/Editor_icon.svg" alt="Editor" class="w-[24px] h-[24px] object-contain"/>
      <span>Editor</span>
    </a>
    <a href="projects.html" class="flex flex-col items-center gap-1 text-[11px] text-white/70">
      <img src="home_assets/Project_icon.svg" alt="Projects" class="w-[24px] h-[24px] object-contain"/>
      <span>Projects</span>
    </a>
    <a href="graph.html" class="flex flex-col items-center gap-1 text-[11px] text-white/70">
      <img src="home_assets/Graph_icon.svg" alt="Graph" class="w-[24px] h-[24px] object-contain opacity-70"/>
      <span>Graph</span>
    </a>
    <a href="social.html" class="flex flex-col items-center gap-1 text-[11px] text-white/70">
      <img src="home_assets/Social_icon.svg" alt="Social" class="w-[24px] h-[24px] object-contain"/>
      <span>Social</span>
    </a>
  </nav>

  <!-- MAIN -->
  <main class="flex-1 flex flex-col relative w-full min-h-screen md:min-h-0 md:h-screen overflow-hidden text-white main-bg">
    <section class="flex-1 overscroll-contain pb-[calc(var(--mobile-nav-h)+16px)] md:pb-[32px]"
             style="overflow-y:hidden; padding-top:15px; padding-left:20px; padding-right:32px;">
      <div class="page-inner">
        <section class="projects-wrapper">
          <section class="right-region">
            <header class="right-header"><div class="hero-title">Projects</div></header>

            <section class="board-shell">
              <div class="board-head-row">
                <div class="board-head-left">My Projects</div>
                <button id="saveBtn" class="save-btn" type="button" title="ì…ë ¥ ë‚´ìš©ì„ ì €ì¥í•˜ê³  ì—ë””í„°ë¡œ ì´ë™" disabled>ì €ì¥ &gt;</button>
              </div>

              <div class="projects-scroller" id="projectsScroll">
                <div class="projects-row" id="projectsRow">
                  <!-- 3ê°œì˜ ì—´ -->
                  <div class="projects-col" id="col1">
                    <!-- Card 1: Header -->
                    <div class="proj-card" id="card1">
                      <div class="proj-toprow">
                        <div class="proj-texts">
                          <div id="title1" class="proj-title" contenteditable="true" spellcheck="false">ìƒˆ í”„ë¡œì íŠ¸ 1...</div>
                          <div class="proj-duedate">
                            <button id="dueDateBtn" type="button" class="underline text-[13px] text-black/60" data-value="">Due Date: í´ë¦­í•˜ì—¬ ì„ íƒ</button>
                          </div>
                        </div>
                        <div id="iconWrap" class="proj-iconwrap" title="í´ë¦­í•˜ì—¬ ì´ëª¨ì§€ ì„¤ì •">LOGO</div>
                      </div>
                      <div class="proj-status-row"><span class="proj-status-dot"></span><span class="proj-status-text">In Progress</span></div>
                      <div class="proj-progressbar"><div class="proj-progress-inner"></div></div>
                      <div class="proj-footer-row">
                        <div class="proj-tasks-text"><span class="done-count">0</span>/<span class="total-count">0</span> Total Tasks</div>
                        <div class="proj-percent"><span class="percent-val">0%</span></div>
                      </div>
                    </div>

                    <!-- Card 2: ë°°ê²½ -->
                    <div class="proj-card" id="card2">
                      <div class="proj-toprow">
                        <div class="proj-texts">
                          <div class="proj-title">ì´ í”„ë¡œì íŠ¸ì˜ ë°°ê²½ì€ ë¬´ì—‡ì¸ê°€ìš”?</div>
                          <div id="bgContent" class="para-input" contenteditable="true" data-placeholder="1í˜ì´ì§€ì—ì„œ ì‘ì„±í•œ ë°°ê²½ì„ ì´ì–´ì„œ ë³´ì™„í•˜ì„¸ìš”."></div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- 2ì—´: BMC í‘œ -->
                  <div class="projects-col" id="col2">
                    <div class="proj-card" id="cardBmc">
                      <div class="proj-toprow">
                        <div class="proj-texts">
                          <div class="proj-title">BMC ìš”ì•½</div>
                        </div>
                      </div>
                      <div id="bmcTable" class="bmc-table"></div>
                    </div>
                  </div>

                  <!-- 3ì—´: PSST ì‘ì„± -->
                  <div class="projects-col" id="col3">
                    <div class="proj-card" id="cardPsst">
                      <div class="proj-toprow">
                        <div class="proj-texts">
                          <div class="proj-title">PSST ì‘ì„±</div>
                        </div>
                      </div>

                      <div class="psst-row">
                        <div class="psst-badge">P</div>
                        <div id="psstP" class="para-input psst-input" contenteditable="true" data-placeholder="Problem â€” ì–´ë–¤ ë¬¸ì œ/ìƒí™©ì„ í’€ ê²ƒì¸ê°€?"></div>
                      </div>

                      <div class="psst-row">
                        <div class="psst-badge">S</div>
                        <div id="psstS1" class="para-input psst-input" contenteditable="true" data-placeholder="Solution â€” ì œì•ˆí•˜ëŠ” í•´ê²°/ê°€ì¹˜"></div>
                      </div>

                      <div class="psst-row">
                        <div class="psst-badge">S</div>
                        <div id="psstS2" class="para-input psst-input" contenteditable="true" data-placeholder="Strategy â€” ì ‘ê·¼ ì „ëµ/ì±„ë„/ìš´ì˜"></div>
                      </div>

                      <div class="psst-row">
                        <div class="psst-badge">T</div>
                        <div id="psstT" class="para-input psst-input" contenteditable="true" data-placeholder="Timeline â€” ë§ˆì¼ìŠ¤í†¤/ì¼ì •/ê²€ì¦ ê³„íš"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </section>
        </section>
      </div>
    </section>
  </main>

  <!-- Date Picker Dialog -->
  <dialog id="dateDialog">
    <div style="padding:14px 14px 8px; min-width:260px;">
      <div style="font-size:12px; font-weight:800; color:#111827; margin-bottom:6px;">ë§ˆê°ì¼ ì„ íƒ</div>
      <input id="dateInput" type="date" class="w-full border rounded px-3 py-2 text-[13px]" />
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
        <button id="dateClear" class="px-3 py-2 text-[12px] rounded border bg-white">ì§€ìš°ê¸°</button>
        <button id="dateCancel" class="px-3 py-2 text-[12px] rounded border bg-white">ì·¨ì†Œ</button>
        <button id="dateOk" class="px-3 py-2 text-[12px] rounded border bg-black text-white">í™•ì¸</button>
      </div>
    </div>
  </dialog>

  <script>
    /* ===== Keys ===== */
    const DRAFT_KEY = 'fw_project_draft_v2';
    const LIST_KEY  = 'fw_projects';
    const LAST_ID_KEY = 'fw_last_project_id';

    /* ===== Helpers ===== */
    const $ = (s, r=document)=> r.querySelector(s);
    const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
    const debounce = (fn, ms=250)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
    function safeParse(j,f=null){ try{ const v=JSON.parse(j); return (v===null||v===undefined)?f:v; }catch(_){ return f; } }
    function toast(msg){
      const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
      requestAnimationFrame(()=> t.classList.add('show')); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=> t.remove(),180); },1600);
    }

    /* ===== Sidebar collapse ===== */
    const sidebar = $('#sidebar');
    $('#collapseToggle')?.addEventListener('click', ()=> sidebar?.setAttribute('data-collapsed','true'));
    $('#brandToggleArea')?.addEventListener('click', ()=> { if(sidebar?.getAttribute('data-collapsed')==='true') sidebar.setAttribute('data-collapsed','false'); });

    /* ===== DOM Refs ===== */
    const titleEl = $('#title1');
    const iconWrap = $('#iconWrap');
    const dueBtn = $('#dueDateBtn');
    const bgEl = $('#bgContent');
    const bmcTable = $('#bmcTable');
    // PSST id ë§¤ì¹­
    const psP = $('#psstP'), psS1 = $('#psstS1'), psS2 = $('#psstS2'), psT = $('#psstT');
    const saveBtn = $('#saveBtn');

    /* ===== Emoji Picker (ì´ˆê°„ë‹¨) ===== */
    const EMOJI_SET = "ğŸš€âœ¨ğŸ”¥ğŸ’¡ğŸ¯ğŸ› ï¸ğŸ“šğŸ“ˆğŸ§ ğŸ§ªğŸ§©ğŸ¨ğŸ—‚ï¸ğŸ“ğŸ—“ï¸â±ï¸ğŸ”âœ…ğŸ’»ğŸ“±ğŸ¤ğŸŒ±ğŸğŸ”§ğŸ”¬ğŸ§µğŸ“£ğŸ’¬ğŸ§­ğŸ—ºï¸".split("");
    let emojiPop = null, emojiOpen = false;
    function buildEmoji(){ const d=document.createElement('div'); d.style.cssText='position:fixed;z-index:10000;min-width:240px;background:#fff;color:#000;border:1px solid rgba(0,0,0,0.12);border-radius:10px;box-shadow:0 20px 60px rgba(0,0,0,0.2);padding:10px;';
      d.innerHTML = `<div style="font-size:12px;font-weight:800;color:#111827;margin-bottom:8px;">ì´ëª¨ì§€ ì„ íƒ</div>
        <div style="display:grid;grid-template-columns:repeat(8,1fr);gap:6px;">${EMOJI_SET.map(e=>`<button type="button" data-emoji="${e}" style="height:28px;border:1px solid rgba(0,0,0,0.06);border-radius:6px;background:#f8fafc;font-size:18px;cursor:pointer;">${e}</button>`).join('')}</div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
          <button type="button" data-act="clear" style="height:28px;padding:0 10px;border-radius:6px;border:1px solid rgba(0,0,0,0.1);background:#f3f4f6;font-size:12px;font-weight:600;cursor:pointer;">ì§€ìš°ê¸°</button>
          <button type="button" data-act="close" style="height:28px;padding:0 10px;border:1px solid #111827;border-radius:6px;background:#111827;color:#fff;font-size:12px;font-weight:600;cursor:pointer;">ë‹«ê¸°</button>
        </div>`;
      return d; }
    function openEmoji(anchor){
      if(!emojiPop){ emojiPop=buildEmoji(); document.body.appendChild(emojiPop);
        emojiPop.addEventListener('click',(e)=>{
          const btn=e.target.closest('button'); if(!btn) return;
          const act=btn.getAttribute('data-act'), emo=btn.getAttribute('data-emoji');
          if(act==='close'){ emojiPop.style.display='none'; emojiOpen=false; return; }
          if(act==='clear'){ setIconEmoji(''); emojiPop.style.display='none'; emojiOpen=false; return; }
          if(emo){ setIconEmoji(emo); emojiPop.style.display='none'; emojiOpen=false; }
        });
      }
      const r=anchor.getBoundingClientRect();
      emojiPop.style.top = Math.min(window.innerHeight-280, r.bottom+8)+'px';
      emojiPop.style.left = Math.min(window.innerWidth-320, r.left)+'px';
      emojiPop.style.display='block'; emojiOpen=true;
      setTimeout(()=> document.addEventListener('mousedown', outside, { once:true }),0);
      function outside(ev){ if(!emojiPop.contains(ev.target) && ev.target!==anchor){ emojiPop.style.display='none'; emojiOpen=false; } }
    }
    function setIconEmoji(emoji){
      if(emoji && Array.from(emoji).length>0){
        iconWrap.setAttribute('data-emoji', Array.from(emoji)[0]);
        iconWrap.innerHTML=`<span class="emoji">${Array.from(emoji)[0]}</span>`;
      }else{
        iconWrap.removeAttribute('data-emoji'); iconWrap.textContent='LOGO';
      }
      saveDebounced();
    }
    iconWrap?.addEventListener('click', ()=> emojiOpen? (emojiPop.style.display='none', emojiOpen=false) : openEmoji(iconWrap));

    /* ===== Date dialog ===== */
    const dateDlg = $('#dateDialog');
    const dateInput = $('#dateInput');
    $('#dueDateBtn')?.addEventListener('click', ()=>{
      const cur = dueBtn.getAttribute('data-value')||'';
      dateInput.value = cur || new Date().toISOString().slice(0,10);
      dateDlg.showModal(); dateInput.focus();
    });
    $('#dateOk')?.addEventListener('click', applyDate);
    $('#dateClear')?.addEventListener('click', ()=>{ dateInput.value=''; applyDate(); });
    $('#dateCancel')?.addEventListener('click', ()=> dateDlg.close());
    function applyDate(){
      const v = (dateInput.value||'').trim();
      if(v){ dueBtn.textContent = `Due Date: ${v}`; dueBtn.classList.add('filled'); dueBtn.setAttribute('data-value', v); }
      else { dueBtn.textContent = 'Due Date: í´ë¦­í•˜ì—¬ ì„ íƒ'; dueBtn.classList.remove('filled'); dueBtn.setAttribute('data-value',''); }
      saveDebounced(); dateDlg.close();
    }

    /* ===== BMC í‘œ ë Œë” ===== */
    const BMC_LABELS = [
      ['cs','ê³ ê° ì„¸ë¶„í™”'], ['cr','ê³ ê° ê´€ê³„'], ['ch','ì±„ë„'],
      ['rs','ìˆ˜ìµ ëª¨ë¸'], ['vp','ê°€ì¹˜ ì œì•ˆ'], ['ka','í•µì‹¬ í™œë™'],
      ['kr','í•µì‹¬ ìì›'], ['kp','í•µì‹¬ íŒŒíŠ¸ë„ˆ'], ['cst','ë¹„ìš© êµ¬ì¡°'],
    ];
    function renderBmcTable(bmc){
      const rows = BMC_LABELS.map(([k,ko])=>{
        const v = (bmc?.[k]||'').trim();
        return `<div class="k">${ko}</div><div class="v">${v? v.replace(/\n/g,'<br/>') : '<span style="color:#9CA3AF">â€”</span>'}</div>`;
      }).join('');
      bmcTable.innerHTML = rows;
    }

    /* ===== Save / Restore ===== */
    function collectPSST(){
      return {
        p: (psP?.textContent||'').trim(),
        s1: (psS1?.textContent||'').trim(),
        s2: (psS2?.textContent||'').trim(),
        t: (psT?.textContent||'').trim(),
      };
    }
    function collectProject(){
      return {
        version: 6,
        id: window.__fw_draft_id || ('fw_' + Date.now()),
        title: (titleEl.textContent||'').trim(),
        dueDate: dueBtn.getAttribute('data-value') || '',
        iconEmoji: iconWrap.getAttribute('data-emoji') || '',
        background: (bgEl.textContent||'').trim(),
        bmc: window.__bmc_cached || {},
        psst: collectPSST(),
        savedAt: new Date().toISOString()
      };
    }
    function updateSaveState(){
      const anyPSST = Object.values(collectPSST()).some(v=> (v||'').length>0);
      const hasBasics = (titleEl.textContent||'').trim().length>0 || (bgEl.textContent||'').trim().length>0;
      saveBtn.disabled = !(hasBasics || anyPSST);
    }
    const saveDebounced = debounce(saveNow, 250);
    function saveNow(){
      const p = collectProject();
      window.__fw_draft_id = p.id;
      try{
        localStorage.setItem(DRAFT_KEY, JSON.stringify(p));
        const list = safeParse(localStorage.getItem(LIST_KEY), []);
        const idx = list.findIndex(x=>x.id===p.id);
        if (idx>=0) list[idx]=p; else list.push(p);
        localStorage.setItem(LIST_KEY, JSON.stringify(list));
        localStorage.setItem(LAST_ID_KEY, p.id);
      }catch(e){ console.error(e); }
      updateSaveState();
    }

    saveBtn?.addEventListener('click', ()=>{
      if(saveBtn.disabled){ toast('ì‘ì„± ë‚´ìš©ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”'); return; }
      saveNow(); toast('ì €ì¥ ì™„ë£Œ Â· Editorë¡œ ì´ë™í•©ë‹ˆë‹¤'); location.href = 'editor.html?projectId=' + encodeURIComponent(window.__fw_draft_id);
    });

    [titleEl,bgEl,psP,psS1,psS2,psT].forEach(el=> el?.addEventListener('input', ()=>{ updateSaveState(); saveDebounced(); }));

    /* ===== ë¶€íŒ…: ë³µì› ===== */
    window.addEventListener('load', ()=>{
      const draft = safeParse(localStorage.getItem(DRAFT_KEY), null);
      if(draft){
        window.__fw_draft_id = draft.id || window.__fw_draft_id;

        if(draft.title) titleEl.textContent = draft.title;
        if(draft.dueDate){
          dueBtn.textContent=`Due Date: ${draft.dueDate}`;
          dueBtn.classList.add('filled'); dueBtn.setAttribute('data-value', draft.dueDate);
        }
        if(draft.iconEmoji) setIconEmoji(draft.iconEmoji);
        if(draft.background) bgEl.textContent = draft.background;

        window.__bmc_cached = draft.bmc || {};
        renderBmcTable(window.__bmc_cached);

        const ps = draft.psst || {};
        if(ps.p)  psP.textContent = ps.p;
        if(ps.s1) psS1.textContent = ps.s1;
        if(ps.s2) psS2.textContent = ps.s2;
        if(ps.t)  psT.textContent = ps.t;
      }else{
        renderBmcTable({});
      }
      updateSaveState();
    });
  </script>
</body>
</html>
